/**
 * almond 0.1.2 Copyright (c) 2011, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/*!
 * Contains the slick.parser library
 * https://github.com/subtleGradient/slick
 */

// Credit: XRegExp 0.6.1 (c) 2007-2008 Steven Levithan <http://stevenlevithan.com/regex/xregexp/> MIT License

/*
 * pQuery physics library v@VERSION
 * https://github.com/wellcaffeinated/pQuery
 * 
 * Copyright 2012, Jasper Palfree
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */

/*
		 * Contains modified parts of jQuery JavaScript Library v1.7.2
		 * http://jquery.com/
		 *
		 * Copyright 2011, John Resig
		 * Dual licensed under the MIT or GPL Version 2 licenses.
		 * http://jquery.org/license
		 *
		 */

/*
 * pQuery physics library v@VERSION
 * https://github.com/wellcaffeinated/pQuery
 * 
 * Copyright 2012, Jasper Palfree
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */

/*
		 * Contains callbacks.js of jQuery JavaScript Library v1.8pre
		 * http://jquery.com/
		 *
		 * Copyright 2011, John Resig
		 * Dual licensed under the MIT or GPL Version 2 licenses.
		 * http://jquery.org/license
		 *
		 * Date: @DATE
		 */

/*
 * pQuery physics library v@VERSION
 * https://github.com/wellcaffeinated/pQuery
 * 
 * Copyright 2012, Jasper Palfree
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */

/*
 * pQuery physics library v@VERSION
 * https://github.com/wellcaffeinated/pQuery
 * 
 * Copyright 2012, Jasper Palfree
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */

/*
 * pQuery physics library v@VERSION
 * https://github.com/wellcaffeinated/pQuery
 * 
 * Copyright 2012, Jasper Palfree
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */

/*
 * pQuery physics library v@VERSION
 * https://github.com/wellcaffeinated/pQuery
 * 
 * Copyright 2012, Jasper Palfree
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */

/*
 * pQuery physics library v@VERSION
 * https://github.com/wellcaffeinated/pQuery
 * 
 * Copyright 2012, Jasper Palfree
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */

/*
 * pQuery physics library v@VERSION
 * https://github.com/wellcaffeinated/pQuery
 * 
 * Copyright 2012, Jasper Palfree
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */

/*
 * pQuery physics library v@VERSION
 * https://github.com/wellcaffeinated/pQuery
 * 
 * Copyright 2012, Jasper Palfree
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */

/*
 * pQuery physics library v@VERSION
 * https://github.com/wellcaffeinated/pQuery
 * 
 * Copyright 2012, Jasper Palfree
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */

/*
 * pQuery physics library v@VERSION
 * https://github.com/wellcaffeinated/pQuery
 * 
 * Copyright 2012, Jasper Palfree
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */

/*
 * pQuery physics library v@VERSION
 * https://github.com/wellcaffeinated/pQuery
 * 
 * Copyright 2012, Jasper Palfree
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */

/*
 * pQuery physics library v@VERSION
 * https://github.com/wellcaffeinated/pQuery
 * 
 * Copyright 2012, Jasper Palfree
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */

/*!
 * pQuery physics library v@VERSION
 * https://github.com/wellcaffeinated/pQuery
 * 
 * Copyright 2012, Jasper Palfree
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * 
 * Date: @DATE
 * @license
 */

/*!
		 * Contains modified parts of jQuery JavaScript Library v1.7.2
		 * http://jquery.com/
		 *
		 * Copyright 2011, John Resig
		 * Dual licensed under the MIT or GPL Version 2 licenses.
		 * http://jquery.org/license
		 *
		 */

/**
 * KineticJS JavaScript Library v3.10.5
 * http://www.kineticjs.com/
 * Copyright 2012, Eric Rowell
 * Licensed under the MIT or GPL Version 2 licenses.
 * Date: Aug 02 2012
 *
 * Copyright (C) 2011 - 2012 by Eric Rowell
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

/**
 * @license RequireJS domReady 2.0.1 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/domReady for details
 */

var requirejs,require,define;(function(undef){function normalize(name,baseName){var baseParts=baseName&&baseName.split("/"),map=config.map,starMap=map&&map["*"]||{},nameParts,nameSegment,mapValue,foundMap,foundI,foundStarMap,starI,i,j,part;if(name&&name.charAt(0)==="."&&baseName){baseParts=baseParts.slice(0,baseParts.length-1),name=baseParts.concat(name.split("/"));for(i=0;part=name[i];i++)if(part===".")name.splice(i,1),i-=1;else if(part===".."){if(i===1&&(name[2]===".."||name[0]===".."))return!0;i>0&&(name.splice(i-1,2),i-=2)}name=name.join("/")}if((baseParts||starMap)&&map){nameParts=name.split("/");for(i=nameParts.length;i>0;i-=1){nameSegment=nameParts.slice(0,i).join("/");if(baseParts)for(j=baseParts.length;j>0;j-=1){mapValue=map[baseParts.slice(0,j).join("/")];if(mapValue){mapValue=mapValue[nameSegment];if(mapValue){foundMap=mapValue,foundI=i;break}}}if(foundMap)break;!foundStarMap&&starMap&&starMap[nameSegment]&&(foundStarMap=starMap[nameSegment],starI=i)}!foundMap&&foundStarMap&&(foundMap=foundStarMap,foundI=starI),foundMap&&(nameParts.splice(0,foundI,foundMap),name=nameParts.join("/"))}return name}function makeRequire(relName,forceSync){return function(){return req.apply(undef,aps.call(arguments,0).concat([relName,forceSync]))}}function makeNormalize(relName){return function(name){return normalize(name,relName)}}function makeLoad(depName){return function(value){defined[depName]=value}}function callDep(name){if(waiting.hasOwnProperty(name)){var args=waiting[name];delete waiting[name],defining[name]=!0,main.apply(undef,args)}if(!defined.hasOwnProperty(name))throw new Error("No "+name);return defined[name]}function makeMap(name,relName){var prefix,plugin,index=name.indexOf("!");return index!==-1?(prefix=normalize(name.slice(0,index),relName),name=name.slice(index+1),plugin=callDep(prefix),plugin&&plugin.normalize?name=plugin.normalize(name,makeNormalize(relName)):name=normalize(name,relName)):name=normalize(name,relName),{f:prefix?prefix+"!"+name:name,n:name,p:plugin}}function makeConfig(name){return function(){return config&&config.config&&config.config[name]||{}}}var defined={},waiting={},config={},defining={},aps=[].slice,main,req;main=function(name,deps,callback,relName){var args=[],usingExports,cjsModule,depName,ret,map,i;relName=relName||name;if(typeof callback=="function"){deps=!deps.length&&callback.length?["require","exports","module"]:deps;for(i=0;i<deps.length;i++){map=makeMap(deps[i],relName),depName=map.f;if(depName==="require")args[i]=makeRequire(name);else if(depName==="exports")args[i]=defined[name]={},usingExports=!0;else if(depName==="module")cjsModule=args[i]={id:name,uri:"",exports:defined[name],config:makeConfig(name)};else if(defined.hasOwnProperty(depName)||waiting.hasOwnProperty(depName))args[i]=callDep(depName);else if(map.p)map.p.load(map.n,makeRequire(relName,!0),makeLoad(depName),{}),args[i]=defined[depName];else if(!defining[depName])throw new Error(name+" missing "+depName)}ret=callback.apply(defined[name],args);if(name)if(cjsModule&&cjsModule.exports!==undef&&cjsModule.exports!==defined[name])defined[name]=cjsModule.exports;else if(ret!==undef||!usingExports)defined[name]=ret}else name&&(defined[name]=callback)},requirejs=require=req=function(deps,callback,relName,forceSync){return typeof deps=="string"?callDep(makeMap(deps,callback).f):(deps.splice||(config=deps,callback.splice?(deps=callback,callback=relName,relName=null):deps=undef),callback=callback||function(){},forceSync?main(undef,deps,callback,relName):setTimeout(function(){main(undef,deps,callback,relName)},15),req)},req.config=function(cfg){return config=cfg,req},define=function(name,deps,callback){deps.splice||(callback=deps,deps=[]),waiting[name]=[name,deps,callback]},define.amd={jQuery:!0}})(),define("almond",function(){}),define("libs/pquery/util/slick.parser",[],function(){function parser(rawMatch,separator,combinator,combinatorChildren,tagName,id,className,attributeKey,attributeOperator,attributeQuote,attributeValue,pseudoClass,pseudoQuote,pseudoClassValue){if(separator||separatorIndex===-1){parsed.expressions[++separatorIndex]=[],combinatorIndex=-1;if(separator)return""}if(combinator||combinatorChildren||combinatorIndex===-1){combinator=combinator||" ";var currentSeparator=parsed.expressions[separatorIndex];reversed&&currentSeparator[combinatorIndex]&&(currentSeparator[combinatorIndex].reverseCombinator=reverseCombinator(combinator)),currentSeparator[++combinatorIndex]={combinator:combinator,tag:"*"}}var currentParsed=parsed.expressions[separatorIndex][combinatorIndex];if(tagName)currentParsed.tag=tagName.replace(reUnescape,"");else if(id)currentParsed.id=id.replace(reUnescape,"");else if(className)className=className.replace(reUnescape,""),currentParsed.classList||(currentParsed.classList=[]),currentParsed.classes||(currentParsed.classes=[]),currentParsed.classList.push(className),currentParsed.classes.push({value:className,regexp:new RegExp("(^|\\s)"+escapeRegExp(className)+"(\\s|$)")});else if(pseudoClass)pseudoClassValue=pseudoClassValue?pseudoClassValue.replace(reUnescape,""):null,currentParsed.pseudos||(currentParsed.pseudos=[]),currentParsed.pseudos.push({key:pseudoClass.replace(reUnescape,""),value:pseudoClassValue});else if(attributeKey){attributeKey=attributeKey.replace(reUnescape,""),attributeValue=(attributeValue||"").replace(reUnescape,"");var test,regexp;switch(attributeOperator){case"^=":regexp=new RegExp("^"+escapeRegExp(attributeValue));break;case"$=":regexp=new RegExp(escapeRegExp(attributeValue)+"$");break;case"~=":regexp=new RegExp("(^|\\s)"+escapeRegExp(attributeValue)+"(\\s|$)");break;case"|=":regexp=new RegExp("^"+escapeRegExp(attributeValue)+"(-|$)");break;case"=":test=function(value){return attributeValue==value};break;case"*=":test=function(value){return value&&value.indexOf(attributeValue)>-1};break;case"!=":test=function(value){return attributeValue!=value};break;default:test=function(value){return!!value}}test||(test=function(value){return value&&regexp.test(value)}),currentParsed.attributes||(currentParsed.attributes=[]),currentParsed.attributes.push({key:attributeKey,operator:attributeOperator,value:attributeValue,test:test})}return""}var parsed,separatorIndex,combinatorIndex,reversed,cache={},reverseCache={},reUnescape=/\\/g,parse=function(expression,isReversed){if(!expression)return null;if(expression.Slick===!0)return expression;expression=(""+expression).replace(/^\s+|\s+$/g,""),reversed=!!isReversed;var currentCache=reversed?reverseCache:cache;if(currentCache[expression])return currentCache[expression];parsed={Slick:!0,expressions:[],raw:expression,reverse:function(){return parse(this.raw,!0)}},separatorIndex=-1;while(expression!=(expression=expression.replace(regexp,parser)));return parsed.length=parsed.expressions.length,currentCache[expression]=reversed?reverse(parsed):parsed},reverseCombinator=function(combinator){return combinator==="!"?" ":combinator===" "?"!":/^!/.test(combinator)?combinator.replace(/^!/,""):"!"+combinator},reverse=function(expression){var expressions=expression.expressions;for(var i=0;i<expressions.length;i++){var exp=expressions[i],last={parts:[],tag:"*",combinator:reverseCombinator(exp[0].combinator)};for(var j=0;j<exp.length;j++){var cexp=exp[j];cexp.reverseCombinator||(cexp.reverseCombinator=" "),cexp.combinator=cexp.reverseCombinator,delete cexp.reverseCombinator}exp.reverse().push(last)}return expression},escapeRegExp=function(string){return string.replace(/[-[\]{}()*+?.\\^$|,#\s]/g,"\\$&")},regexp=new RegExp("^(?:\\s*(,)\\s*|\\s*(<combinator>+)\\s*|(\\s+)|(<unicode>+|\\*)|\\#(<unicode>+)|\\.(<unicode>+)|\\[\\s*(<unicode1>+)(?:\\s*([*^$!~|]?=)(?:\\s*(?:([\"']?)(.*?)\\9)))?\\s*\\](?!\\])|:+(<unicode>+)(?:\\((?:([\"']?)((?:\\([^\\)]+\\)|[^\\(\\)]*)+)\\12)\\))?)".replace(/<combinator>/,"["+escapeRegExp(">+~`!@$%^&={}\\;</")+"]").replace(/<unicode>/g,"(?:[\\w\\u00a1-\\uFFFF-]|\\\\[^\\s0-9a-f])").replace(/<unicode1>/g,"(?:[:\\w\\u00a1-\\uFFFF-]|\\\\[^\\s0-9a-f])")),Slick=this.Slick||{};return Slick.parse=function(expression){return parse(expression)},Slick.escapeRegExp=escapeRegExp,Slick}),define("libs/pquery/util/tools",[],function(){Array.prototype.indexOf=Array.prototype.indexOf||function(searchElement,fromIndex){if(this==null)throw new TypeError;var t=Object(this),len=t.length>>>0;if(len===0)return-1;var n=0;arguments.length>0&&(n=Number(arguments[1]),n!=n?n=0:n!=0&&n!=Infinity&&n!=-Infinity&&(n=(n>0||-1)*Math.floor(Math.abs(n))));if(n>=len)return-1;var k=n>=0?n:Math.max(len-Math.abs(n),0);for(;k<len;k++)if(k in t&&t[k]===searchElement)return k;return-1};var class2type={},toString=Object.prototype.toString,hasOwn=Object.prototype.hasOwnProperty,push=Array.prototype.push,slice=Array.prototype.slice,trim=String.prototype.trim,indexOf=Array.prototype.indexOf,Tools={extend:function(){var options,name,src,copy,copyIsArray,clone,target=arguments[0]||{},i=1,length=arguments.length,deep=!1;typeof target=="boolean"&&(deep=target,target=arguments[1]||{},i=2),typeof target!="object"&&!Tools.isFunction(target)&&(target={}),length===i&&(target=this,--i);for(;i<length;i++)if((options=arguments[i])!=null)for(name in options){src=target[name],copy=options[name];if(target===copy)continue;deep&&copy&&(Tools.isPlainObject(copy)||(copyIsArray=Tools.isArray(copy)))?(copyIsArray?(copyIsArray=!1,clone=src&&Tools.isArray(src)?src:[]):clone=src&&Tools.isPlainObject(src)?src:{},target[name]=Tools.extend(deep,clone,copy)):copy!==undefined&&(target[name]=copy)}return target},isFunction:function(obj){return Tools.type(obj)==="function"},isArray:Array.isArray||function(obj){return Tools.type(obj)==="array"},isNumeric:function(obj){return!isNaN(parseFloat(obj))&&isFinite(obj)},isNumericQuick:function(obj){return obj===0||obj==="0"||(obj&&obj!==!0?obj>>>0!=0||(obj*=obj)*obj<obj:!1)},type:function(obj){return obj==null?String(obj):class2type[toString.call(obj)]||"object"},isPlainObject:function(obj){if(!obj||Tools.type(obj)!=="object"||obj.nodeType||obj==obj.window)return!1;try{if(obj.constructor&&!hasOwn.call(obj,"constructor")&&!hasOwn.call(obj.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return!1}var key;for(key in obj);return key===undefined||hasOwn.call(obj,key)},isEmptyObject:function(obj){for(var name in obj)return!1;return!0},error:function(msg){throw new Error(msg)},noop:function(){},each:function(object,callback,args){var name,i=0,length=object.length,isObj=length===undefined||Tools.isFunction(object);if(args){if(isObj){for(name in object)if(callback.apply(object[name],args)===!1)break}else for(;i<length;)if(callback.apply(object[i++],args)===!1)break}else if(isObj){for(name in object)if(callback.call(object[name],name,object[name])===!1)break}else for(;i<length;)if(callback.call(object[i],i,object[i++])===!1)break;return object},makeArray:function(array,results){var ret=results||[];if(array!=null){var type=Tools.type(array);array.length==null||type==="string"||type==="function"||type==="regexp"||array===array.window?push.call(ret,array):Tools.merge(ret,array)}return ret},inArray:function(elem,array,i){var len;if(array){if(indexOf)return indexOf.call(array,elem,i);len=array.length,i=i?i<0?Math.max(0,len+i):i:0;for(;i<len;i++)if(i in array&&array[i]===elem)return i}return-1},merge:function(first,second){var i=first.length,j=0;if(typeof second.length=="number")for(var l=second.length;j<l;j++)first[i++]=second[j];else while(second[j]!==undefined)first[i++]=second[j++];return first.length=i,first},parseXML:function(data){if(typeof data!="string"||!data)return null;var xml,tmp;try{window.DOMParser?(tmp=new DOMParser,xml=tmp.parseFromString(data,"text/xml")):(xml=new ActiveXObject("Microsoft.XMLDOM"),xml.async="false",xml.loadXML(data))}catch(e){xml=undefined}return(!xml||!xml.documentElement||xml.getElementsByTagName("parsererror").length)&&Tools.error("Invalid XML: "+data),xml},now:function(){return(new Date).getTime()},guid:1,proxy:function(fn,context){if(typeof context=="string"){var tmp=fn[context];context=fn,fn=tmp}if(!Tools.isFunction(fn))return undefined;var args=slice.call(arguments,2),proxy=function(){return fn.apply(context,args.concat(slice.call(arguments)))};return proxy.guid=fn.guid=fn.guid||proxy.guid||Tools.guid++,proxy},unique:function(results){var i,j,l;for(i=0,l=results.length;i<l;i++)for(j=i+1;j<l;j++)results[i]===results[j]&&(results.splice(j--,1),l--);return results}};return Tools.each("Boolean Number String Function Array Date RegExp Object".split(" "),function(i,name){class2type["[object "+name+"]"]=name.toLowerCase()}),Tools}),define("libs/pquery/util/callbacks",["./tools"],function(Tools){(function(jQuery){function createOptions(options){var object=optionsCache[options]={};return jQuery.each(options.split(/\s+/),function(_,flag){object[flag]=!0}),object}var optionsCache={};jQuery.Callbacks=function(options){options=typeof options=="string"?optionsCache[options]||createOptions(options):jQuery.extend({},options);var list=[],stack=!options.once&&[],memory,fired,firing,firingStart,firingLength,firingIndex,fire=function(data){memory=options.memory&&data,fired=!0,firingIndex=firingStart||0,firingStart=0,firingLength=list.length,firing=!0;for(;list&&firingIndex<firingLength;firingIndex++)if(list[firingIndex].apply(data[0],data[1])===!1&&options.stopOnFalse){memory=!1;break}firing=!1,list&&(stack?stack.length&&fire(stack.shift()):memory?list=[]:self.disable())},self={add:function(){if(list){var start=list.length;(function e(args){jQuery.each(args,function(_,arg){jQuery.isFunction(arg)&&(!options.unique||!self.has(arg))?list.push(arg):arg&&arg.length&&add(arg)})})(arguments),firing?firingLength=list.length:memory&&(firingStart=start,fire(memory))}return this},remove:function(){return list&&jQuery.each(arguments,function(_,arg){var index;while((index=jQuery.inArray(arg,list,index))>-1)list.splice(index,1),firing&&(index<=firingLength&&firingLength--,index<=firingIndex&&firingIndex--)}),this},has:function(fn){return jQuery.inArray(fn,list)>-1},empty:function(){return list=[],this},disable:function(){return list=stack=memory=undefined,this},disabled:function(){return!list},lock:function(){return stack=undefined,memory||self.disable(),this},locked:function(){return!stack},fireWith:function(context,args){return args=args||[],args=[context,args.slice?args.slice():args],list&&(!fired||stack)&&(firing?stack.push(args):fire(args)),this},fire:function(){return self.fireWith(this,arguments),this},fired:function(){return!!fired}};return self}})(Tools);var ret=Tools.Callbacks;return Tools.Callbacks=undefined,ret}),define("libs/pquery/util/request-anim-frame",["require"],function(win){var API={},win=window,lastTime=0,vendors=["ms","moz","webkit","o"];for(var x=0;x<vendors.length&&!window.requestAnimationFrame;++x)API.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"],API.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"];return window.requestAnimationFrame||(API.requestAnimationFrame=function(callback,element){var currTime=(new Date).getTime(),timeToCall=Math.max(0,16-(currTime-lastTime)),id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);return lastTime=currTime+timeToCall,id}),window.cancelAnimationFrame||(API.cancelAnimationFrame=function(id){clearTimeout(id)}),API}),define("libs/pquery/util/ticker",["./request-anim-frame"],function(frame){function each(arr,fn){for(var i=0,l=arr.length;i<l;++i)if(fn(arr[i],i)===!1)return!1;return!0}function step(time){if(!active)return;frame.requestAnimationFrame(step),each(listeners,function(l){l(time,time-lastTime)}),lastTime=time}function start(){return lastTime=(new Date).getTime(),active=!0,step(),API}function stop(){return active=!1,API}function subscribe(listener){function cb(l){if(l===listener)return!1}return typeof listener=="function"&&each(listeners,cb)&&listeners.push(listener),API}function unsubscribe(listener){return each(listeners,function(l,i){if(l===listener)return listeners.splice(i,1),!1}),API}function isActive(){return!!active}var API,lastTime=0,active=!1,listeners=[];return API={start:start,stop:stop,subscribe:subscribe,unsubscribe:unsubscribe,isActive:isActive}}),define("libs/pquery/math/vector2",[],function(){function Vector(x,y){if(!(this instanceof arguments.callee))return new Vector(x,y);this.set(x||0,y||0)}return Vector.vadd=function(v1,v2){return new Vector(v1.x+v2.x,v1.y+v2.y)},Vector.vsub=function(v1,v2){return new Vector(v1.x-v2.x,v1.y-v2.y)},Vector.mult=function(m,v1){return new Vector(v1.x*m,v.y*m)},Vector.proj=function(v1,v2){return Vector.mult(v1.dot(v2)/v2.normSq(),v2)},Vector.prototype.set=function(x,y){return this._norm=!1,this._normSq=!1,this.x=x,this.y=y,this},Vector.prototype.vadd=function(v){return this._norm=!1,this._normSq=!1,this.x+=v.x,this.y+=v.y,this},Vector.prototype.vsub=function(v){return this._norm=!1,this._normSq=!1,this.x-=v.x,this.y-=v.y,this},Vector.prototype.add=function(x,y){return this._norm=!1,this._normSq=!1,this.x+=x,this.y+=y===undefined?x:y,this},Vector.prototype.sub=function(x,y){return this._norm=!1,this._normSq=!1,this.x-=x,this.y-=y===undefined?x:y,this},Vector.prototype.mult=function(m){return this._normSq&&(this._normSq*=m,this._norm*=m),this.x*=m,this.y*=m,this},Vector.prototype.dot=function(v){return this.x*v.x+this.y*v.y},Vector.prototype.cross=function(v){return this.x*v.y-this.y*v.x},Vector.prototype.proj=function(v){var m=this.dot(v)/v.normSq();return this.clone(v).mult(m)},Vector.prototype.norm=function(){return this._norm!==!1?this._norm:this._norm=Math.sqrt(this._normSq=this.x*this.x+this.y*this.y)},Vector.prototype.normSq=function(){return this._normSq!==!1?this._normSq:this._normSq=this.x*this.x+this.y*this.y},Vector.prototype.dist=function(v){var dx,dy;return Math.sqrt((dx=v.x-this.x)*dx+(dy=v.y-this.y)*dy)},Vector.prototype.distSq=function(v){var dx,dy;return(dx=v.x-this.x)*dx+(dy=v.y-this.y)*dy},Vector.prototype.normalize=function(){var m=this.norm();return m===0?this:(this.x/=m,this.y/=m,this._norm=1,this._normSq=1,this)},Vector.prototype.clone=function(v){return v?(this._norm=!1,this._normSq=!1,this.x=v.x,this.y=v.y,this):new Vector(this.x,this.y)},Vector.prototype.toNative=function(){return{x:this.x,y:this.y}},Vector.prototype.copyTo=function(v){return v.clone(this),this},Vector.prototype.zero=function(){return this._norm=0,this._normSq=0,this.x=0,this.y=0,this},Vector.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},Vector.prototype.clamp=function(minV,maxV){return this.x=Math.min(Math.max(this.x,minV.x),maxV.x),this.y=Math.min(Math.max(this.y,minV.y),maxV.y),this._norm=this._normSq=!1,this},Vector.prototype.toString=function(){return"("+this.x+", "+this.y+")"},Vector}),define("libs/pquery/math/vector",["./vector2"],function(Vector){return Vector}),define("libs/pquery/physics/algorithms",["../util/tools","../math/vector"],function(Tools,Vector){return{interactions:{NewtonianGravity:function(strength){var i,l,other,pos,otherpos=new Vector,lensq,g;return{beforeAccel:function(dt,obj,idx,list){for(i=idx+1,l=list.length;i<l;i++)pos=obj.position(),other=list[i],otherpos.clone(other.position()),otherpos.vsub(pos),lensq=otherpos.normSq(),g=strength/lensq,obj.accelerate(otherpos.normalize().mult(g)),other.accelerate(otherpos.negate())}}},Drag:function(strength){var v=new Vector,l,x,y,z;return strength=Math.max(Math.min(strength,1),0),{beforeAccel:function(dt,obj,idx,list){v.clone(obj.velocity()),v.mult(1-strength),obj.velocity(v)}}},SphereCollide:function(friction){function fn(dt,obj,idx,list){pos1.clone(obj.position()),fixed1=obj.attr("fixed"),r=obj.dimensions().radius;for(i=idx+1,l=list.length;i<l;i++){other=list[i],fixed2=other.attr("fixed");if(fixed1&&fixed2)continue;diff.clone(pos2.clone(other.position())),diff.vsub(pos1),target=r+other.dimensions().radius;if(diff.x<target&&diff.y<target&&(len=diff.norm())<target){factor=(fixed1||fixed2?1:.5)*(len-target)/len,preserveImpulse&&(v1.clone(obj.velocity()),v2.clone(other.velocity())),diff.mult(factor),fixed1||obj.position(pos1.vadd(diff)),fixed2||other.position(pos2.vsub(diff));if(preserveImpulse){diff.normalize(),factor=v2.dot(diff)-v1.dot(diff);if(factor>=0)continue;diff.mult(factor*(1-.5*friction));if(fixed2){obj.velocity(v1.vadd(diff.mult(2)));continue}if(fixed1){other.velocity(v2.vsub(diff.mult(2)));continue}v1.vadd(diff),v2.vsub(diff),obj.velocity(v1),other.velocity(v2),obj.collisionNotify(other),other.collisionNotify(obj)}}}}var len,target,diff=new Vector,pos1=new Vector,pos2=new Vector,r,i,l,v1=new Vector,v2=new Vector,other,factor,fixed1,fixed2,preserveImpulse=!1;return friction=Math.max(Math.min(friction,1),0),{afterAccel:fn,afterInertia:function(dt,obj,idx,list){preserveImpulse=!0,fn(dt,obj,idx,list),preserveImpulse=!1}}},ConstrainWithin:function(boundsOrParent,energyLoss){function fn(dt,obj,idx,list,par){collide=!1,pos.clone(obj.position()),whd=obj.dimensions(),whd.radius?whd.x=whd.y=whd.z=whd.radius:(whd.x/=2,whd.y/=2,whd.z/=2);if(preserveImpulse){v.clone(obj.velocity());if(pos.x>max.x-whd.x||pos.x<min.x+whd.x)v.x=(energyLoss-1)*v.x,collide=!0;if(pos.y>max.y-whd.y||pos.y<min.y+whd.y)v.y=(energyLoss-1)*v.y,collide=!0;if(pos.z>max.z-whd.z||pos.z<min.z+whd.z)v.z=(energyLoss-1)*v.z,collide=!0}pos.clamp({x:min.x+whd.x,y:min.y+whd.y,z:min.z+whd.z},{x:max.x-whd.x,y:max.y-whd.y,z:max.z-whd.z}),obj.position(pos),preserveImpulse&&obj.velocity(v),collide&&(obj.collisionNotify(boundsOrParent),boundsOrParent.collisionNotify&&boundsOrParent.collisionNotify(obj))}var pos=new Vector,v=new Vector,min,max=new Vector,whd,upper,lower,count,fric,collide,preserveImpulse=!1;return boundsOrParent=boundsOrParent.pquery?boundsOrParent[0]:boundsOrParent,typeof boundsOrParent.dimensions=="function"?(typeof boundsOrParent.position=="function"&&(min=boundsOrParent.position()),min=min||{x:0,y:0,z:0},whd=boundsOrParent.dimensions()):typeof boundsOrParent=="object"?(min=boundsOrParent.min,whd=boundsOrParent.max):min=whd={},min.x=Tools.isNumericQuick(min.x)?min.x:-1/0,min.y=Tools.isNumericQuick(min.y)?min.y:-1/0,min.z=Tools.isNumericQuick(min.z)?min.z:-1/0,max.x=min.x+whd.x,max.y=min.y+whd.y,max.z=min.z+whd.z,max.x=Tools.isNumericQuick(max.x)?max.x:1/0,max.y=Tools.isNumericQuick(max.y)?max.y:1/0,max.z=Tools.isNumericQuick(max.z)?max.z:1/0,{afterAccel:fn,afterInertia:function(dt,obj,idx,list,par){preserveImpulse=!0,fn(dt,obj,idx,list,par),preserveImpulse=!1}}}}}}),define("libs/pquery/util/class",["./tools"],function(Tools){function Class(obj,name){var constructor=name?obj[name]:obj.__constructor__||Tools.noop;if(obj.__extends__)var base=obj.__extends__.prototype;else var base={};return constructor.prototype=Tools.extend({},base,obj),constructor}return Class}),define("libs/pquery/physics/body",["../util/class","../util/tools","../util/callbacks"],function(Class,Tools,Callbacks){var idSeed="body"+(""+Math.random()).replace(/\D/g,""),lastId=0,Body=Class({_type:"body",_events:["modified","children.modified"],Body:function(id){var _=this._={};_.id=id||null,_.classes=[],_.oldclasses=this._classes,_.parent=null,_.children={},_.callbacks={},_.bubble={},_.attr={},_.data={};var evt,self=this;for(var i=0,l=this._events.length;i<l;i++)evt=this._events[i],!function(cb){_.bubble[evt]=function(){cb.fire.apply(cb,arguments)}}(_.callbacks[evt]=Callbacks())},_fire:function(evt,args){return this._.callbacks[evt].fireWith(this,args),this},subscribe:function(evt,callback){var cb=this._.callbacks[evt];return cb&&cb.add(callback),this},unsubscribe:function(evt,callback){var cb=this._.callbacks[evt];return cb&&cb.remove(callback),this},requestUniqueId:function(){return idSeed+lastId++},type:function(){return this._type},id:function(val){var _=this._,par=this.parent();return val&&typeof val=="string"?par?(par.remove(this),_.id=val,par.add(this),_.id):(_.id!==val&&this._fire("modified",[[this],this,"id"]),_.id=val):_.id||(par?_.id=par.requestUniqueId():null)},addClass:function(str){var _=this._,oldlen=_.classes.length;return this.removeClass(str),_.classes.push.apply(_.classes,str.split(" ")),_.classes.length!==oldlen&&this._fire("modified",[[this],this,"classes"]),this},removeClass:function(str){var _=this._,cls=str.split(" "),classes=_.classes,idx,oldlen=_.classes.length;for(var i=0,l=cls.length;i<l;++i)(idx=classes.indexOf(cls[i]))>=0&&classes.splice(idx,1);return _.classes.length!==oldlen&&this._fire("modified",[[this],this,"classes"]),this},toggleClass:function(str,stateVal){var type=typeof str,isBool=typeof stateVal=="boolean";if(type==="string"){var cls=str.split(" "),c,state=stateVal,i=0;while(c=cls[i++])state=isBool?state:!this.hasClass(c),this[state?"addClass":"removeClass"](c)}else if(type==="undefined"||type==="boolean"){var _=this._,l,old=_.classes;if(l=_.classes.length)_.oldclasses=_.classes;_.classes=l&&str!==!0||str===!1?[]:_.oldclasses||[],old!==_.classes&&this._fire("modified",[[this],this,"classes"])}return this},classes:function(str){return str&&this.addClass(str),this._.classes.join(" ")},hasClass:function(str){var args=[].slice.call(arguments),a,ret=!0;while(a=args.shift())ret=ret&&this._.classes.indexOf(a)>=0;return ret},add:function(body){var _=this._;return body.parent(this)===this&&(_.children[body.id()]=body,body.subscribe("children.modified",_.bubble["children.modified"]),body.subscribe("modified",_.bubble["children.modified"]),this._fire("children.modified",[[body],this,"children"])),this},addTo:function(par){return par.add(this),this},remove:function(body){var _=this._;return body.parent()===this&&(body.parent(null),delete _.children[body.id()],body.unsubscribe("children.modified",_.bubble["children.modified"]),body.unsubscribe("modified",_.bubble["children.modified"]),this._fire("children.modified",[[body],this,"children"])),this},parent:function(par){var _=this._;return(par||par===null)&&_.parent!==par&&this!==par&&par.parents().indexOf(this)<0&&(_.parent&&_.parent.remove(this),_.parent=par,par&&_.parent.add(this)),_.parent},parents:function(){var par=this.parent(),ret;return par?(ret=par.parents(),ret.unshift(par),ret):[]},children:function(narrow,deep){var _=this._,ret=[],retVal,c;deep=narrow===!0||!!deep,narrow=typeof narrow=="boolean"?!1:narrow;if(!narrow){for(var id in _.children)ret.push(c=_.children[id]),deep&&ret.push.apply(ret,c.children(narrow,deep));return ret}if(Tools.isFunction(narrow)){for(var id in _.children)retVal=!!narrow(c=_.children[id],id,this),retVal&&ret.push(c),deep&&ret.push.apply(ret,c.children(narrow,deep));return ret}if(typeof narrow=="string"){retVal=/^(#|\.)?([\w]+)$/.exec(narrow);if(!retVal)return[];var _=this._,prop=retVal[1]?retVal[1]==="#"?"id":"hasClass":"type",val=retVal[2];if(prop==="id"){c=_.children[val];if(c)return[c];if(deep)for(var id in _.children)if(c=_.children[id])return[c];return ret}for(var id in _.children)c=_.children[id],retVal=c[prop]()===val,retVal&&ret.push(c),deep&&ret.push.apply(ret,c.children(narrow,deep))}return ret},contains:function(child){if(this===child)return!1;var _=this._;for(var i=0,l=_.children.length;i<l;++i)if(child===_.children[i]||_.children[i].contains(child))return!0;return!1},attr:function(key,val){return val!==undefined?this._.attr[key]=val:this._.attr[key]},data:function(hash,val){return val!==undefined?this._.data[hash]=val:this._.data[hash]}},"Body");return Body.isBody=function(b){return b instanceof Body},Body}),define("libs/pquery/physics/world",["../util/tools","../util/class","./body","../math/vector"],function(Tools,Class,Body,Vector){var World=Class({_type:"world",_events:Body.prototype._events.concat(["step"]),World:function(){World.prototype.__extends__.call(this);var _=this._;_.interactions={beforeAccel:[],afterAccel:[],afterInertia:[]},_.childCache=null,_.refreshChildren=!0,this.subscribe("children.modified",function(){_.refreshChildren=!0}),_.dimensions=new Vector,_.dimensions.set(1/0,1/0,1/0),_.dt=8},__extends__:Body,parent:function(){return!1},dimensions:function(x,y,z){var d=this._.dimensions;return arguments.length>0&&d.set(x!==undefined?x:d.x,y!==undefined?y:d.y,z!==undefined?z:d.z),d.toNative()},registerInteraction:function(type,bodies,callback,par){var _=this._,intr={},p=par||this;return type in _.interactions&&(Tools.isFunction(bodies)?(p.subscribe("children.modified",function(modified){intr.bodies=bodies(par)}),intr.bodies=bodies(par)):intr.bodies=bodies,intr.parent=par,intr.callback=callback,_.interactions[type].push(intr)),this},doInteractions:function(type,dt){var list=this._.interactions[type],intr,bodies,par,ch,i,l,j,m;if(!list)return this;for(i=0,l=list.length;i<l;++i){intr=list[i],bodies=intr.bodies,par=intr.parent;for(j=0,m=bodies.length;j<m;++j)intr.callback.call(ch=bodies[j],dt,ch,j,bodies,par)}return this},resolveAcceleration:function(dt){var children=this._.childCache,i=children.length-1;for(;i>-1;i--)children[i].resolveAcceleration(dt)},resolveInertia:function(dt){var children=this._.childCache,i=children.length-1;for(;i>-1;i--)children[i].resolveInertia(dt)},onestep:function(){var _=this._,dt=_.dt;return _.refreshChildren&&(_.childCache=this.children(function(c){return c.timeStep(_.dt),!0},!0),_.refreshChildren=!1),_.time+=dt,this.doInteractions("beforeAccel",dt),this.resolveAcceleration(dt),this.doInteractions("afterAccel",dt),this.resolveInertia(dt),this.doInteractions("afterInertia",dt),_.time},timeStep:function(dt){if(dt){this._.dt=dt;if(!this._.childCache)return this;var children=this._.childCache,i=children.length-1;for(;i>-1;i--)children[i].timeStep(dt);return this}return this._.dt},step:function(now){if(this.paused)return this._.time=!1,this;var _=this._,time=_.time||(_.time=now),diff=now-time;if(!diff)return this;this.FPS=1e3/diff,this.nsteps=Math.ceil(diff/_.dt),now-time>250&&(_.time=now-250);while(this.onestep()<now);return this._fire("step",[_.dt,_.time]),this},pause:function(){return this.paused=!0,this},unpause:function(){return this.paused=!1,this},isPaused:function(){return!!this.paused}},"World");return World.isWorld=function(w){return w instanceof World},World}),define("libs/pquery/physics/phygets/basic",["../../util/class","../../util/tools","../../math/vector","../body"],function(Class,Tools,Vector,Body){var Basic=Class({_type:"basic",_events:Body.prototype._events.concat(["physics.modified","collide"]),Basic:function(){Basic.prototype.__extends__.call(this);var _=this._;_.pos=new Vector,_.mid=new Vector,_.prev=new Vector,_.v=new Vector,_.a=new Vector,_.dt=1,_.dimensions=new Vector,_.midInt=!1},__extends__:Body,resolveAcceleration:function(dt){var _=this._;if(_.attr.fixed)return;_.midInt=!0,_.mid.clone(_.pos),_.pos.vadd(_.a.mult(dt*dt)),_.a.zero()},resolveInertia:function(dt){var _=this._;if(_.attr.fixed)return;_.midInt=!1,_.pos.vadd(_.mid).vsub(_.prev),_.prev.clone(_.mid)},dimensions:function(x,y,z){var d=this._.dimensions;return arguments.length>0&&d.set(x!==undefined?x:d.x,y!==undefined?y:d.y,z!==undefined?z:d.z),d.toNative()},AABB:function(){return{x:0,y:0,z:0}},position:function(pos,y,z){var _=this._,type,prev=!1;if(pos!==undefined||y!==undefined||z!==undefined)type=typeof pos,type==="object"?_.pos.set(pos.x!==undefined?pos.x:_.pos.x,pos.y!==undefined?pos.y:_.pos.y,pos.z!==undefined?pos.z:_.pos.z):_.pos.set(pos!==undefined?pos:_.pos.x,y!==undefined?y:_.pos.y,z!==undefined?z:_.pos.z);return _.pos.toNative()},velocity:function(vel,y,z){var _=this._,pos=_.pos,type,isfixed=_.attr.fixed;return isfixed?_.v.zero().toNative():vel!==undefined||y!==undefined||z!==undefined?(type=typeof vel,_.mid.clone(_.pos),type==="object"?_.prev.clone(_.mid).vsub(_.v.set(vel.x!==undefined?vel.x:0,vel.y!==undefined?vel.y:0,vel.z!==undefined?vel.z:0).mult(_.dt)):_.prev.clone(_.mid).vsub(_.v.set(vel!==undefined?vel:0,y!==undefined?y:0,z!==undefined?z:0).mult(_.dt)),_.v.mult(1/_.dt).toNative()):_.v.clone(pos).vsub(_.prev).mult(1/_.dt).toNative()},accelerate:function(accel,y,z){var _=this._,type,isfixed=_.attr.fixed;if(isfixed)return _.a.zero().toNative();if(accel!==undefined||y!==undefined||z!==undefined)type=typeof accel,type==="object"?_.a.add(accel.x!==undefined?accel.x:0,accel.y!==undefined?accel.y:0,accel.z!==undefined?accel.z:0):_.a.add(accel!==undefined?accel:0,y!==undefined?y:0,z!==undefined?z:0);return this},collisionNotify:function(other){this._fire("collide",[other])},timeStep:function(dt){if(dt){var v=this.velocity();return this._.dt=dt,this.velocity(v),this}return this._.dt}},"Basic");return Basic}),define("libs/pquery/physics/phygets/sphere",["../../util/class","./basic"],function(Class,Basic){var Sphere=Class({_type:"sphere",Sphere:function(){Sphere.prototype.__extends__.call(this),this._.radius=0},__extends__:Basic,dimensions:function(r){return r!==undefined&&(this._.radius=r||r.radius||0),{radius:this._.radius}},AABB:function(){var _=this._;return{x:_.radius,y:_.radius,z:_.radius}}},"Sphere");return Sphere}),define("libs/pquery/physics/phygets/point",["../../util/class","./basic"],function(Class,Basic){var Point=Class({_type:"point",Point:function(){Point.prototype.__extends__.call(this)},__extends__:Basic,dimensions:function(){return{x:0,y:0,z:0}}},"Point");return Point}),define("libs/pquery/physics/phyget",["./body","./phygets/sphere","./phygets/point"],function(Body,Sphere,Point){function create(type){return new PhygetRegistry[type]}function isBody(b){var bdy=b,ret=!1;while(bdy&&!(ret=bdy instanceof Body))bdy=bdy.__extends__;return ret}var PhygetRegistry={sphere:Sphere,point:Point};return{create:create,isBody:isBody}}),define("libs/pquery/pquery",["./util/slick.parser","./util/tools","./util/callbacks","./util/ticker","./math/vector","./physics/algorithms","./physics/world","./physics/phyget"],function(Slick,Tools,Callbacks,Ticker,Vector,Algorithms,World,Phyget){function inWorld(body,world){var p=body.parents();return p[p.length-1]===world}var pQuery=function(selector,context){return new pQuery.fn.init(selector,context,rootpQuery)},noContext=!1,quickExpr=/^(?:[^#<]*(<[\w\W]+>)[^>]*$|#([\w\-]*)$)/,rnotwhite=/\S/,trimLeft=/^\s+/,trimRight=/\s+$/,rsingleTag=/^<(\w+)\s*\/?>(?:<\/\1>)?$/,rootpQuery,worldMethods;return pQuery.fn=pQuery.prototype={constructor:pQuery,init:function(selector,context,rootpQuery){var match,elem,ret,doc;if(!selector)return this;if(Phyget.isBody(selector))return this.context=this[0]=selector,this.length=1,this;if(selector==="world"&&!context)return this.context=this.world,this[0]=this.world,this.selector=selector,this.length=1,this;if(typeof selector=="string"){selector.charAt(0)==="<"&&selector.charAt(selector.length-1)===">"&&selector.length>=3?match=[null,selector,null]:match=quickExpr.exec(selector);if(!match||!match[1])return!context||context.pquery?(context||rootpQuery).find(selector):this.constructor(context).find(selector);if(match[1])return context=context instanceof pQuery?context[0]:context,doc=context||this.world,ret=rsingleTag.exec(selector),ret?selector=[pQuery.createPhyget(ret[1])]:pQuery.error("Only simple <tag> creation is supported"),pQuery.merge(this,selector)}return selector.selector!==undefined&&(this.selector=selector.selector,this.context=selector.context),pQuery.makeArray(selector,this)},selector:"",pquery:"0.1a",length:0,each:function(callback,args){return pQuery.each(this,callback,args)},pushStack:function(elems,name,selector){var ret=this.constructor();return pQuery.isArray(elems)?this.push.apply(ret,elems):pQuery.merge(ret,elems),ret.prevObject=this,ret.context=this.context,name==="find"?ret.selector=this.selector+(this.selector?" ":"")+selector:name&&(ret.selector=this.selector+"."+name+"("+selector+")"),ret},push:Array.prototype.push},pQuery.fn.init.prototype=pQuery.fn,pQuery.fn.extend=pQuery.extend=Tools.extend,pQuery.extend(Tools),pQuery.extend(Algorithms),pQuery.Callbacks=Callbacks,pQuery.Vector=Vector,pQuery.extend({ticker:Ticker,sub:function(){function pQuerySub(selector,context){return new pQuerySub.fn.init(selector,context)}pQuery.extend(!0,pQuerySub,this),pQuerySub.superclass=this,pQuerySub.fn=pQuerySub.prototype=this(),pQuerySub.fn.constructor=pQuerySub,pQuerySub.fn.world=new World,pQuerySub.sub=this.sub,pQuerySub.fn.init=function(selector,context){return context&&context instanceof pQuery&&!(context instanceof pQuerySub)&&(context=pQuerySub(context)),pQuery.fn.init.call(this,selector,context,rootpQuerySub)},pQuerySub.fn.init.prototype=pQuerySub.fn;var rootpQuerySub=pQuerySub("world");return pQuerySub},createPhyget:function(type){var ret=Phyget.create(type);return ret||pQuery.error("Invalid phyget type: "+type),ret}}),!function(){function makeArray(array,results){return array=Array.prototype.slice.call(array,0),results?(results.push.apply(results,array),results):array}pQuery.find=function(selector,context,results){function filter(child,id,parent){var acceptParents,body,testid,check,comb,last,j,currentBit,i,currentExpression;e:for(i=0;currentExpression=expressions[i];i++){acceptParents={},body=child,testid=id,last=currentExpression.length-1,j=last,currentBit=currentExpression[j];do{testid=body.id();if(j===currentExpression.length-2&&acceptParents[testid])return!0;check=!currentBit.id||currentBit.id===testid,check=check&&(!currentBit.classList||body.hasClass.apply(body,currentBit.classList)),check=check&&(!currentBit.tag||currentBit.tag==="*"||body.type()===currentBit.tag);if(j===last){if(!check)continue e}else{if(comb===">"&&!check)continue e;if(!check)continue}comb=currentBit.combinator,j--,currentBit=currentExpression[j];if(!currentBit){if(comb===">"&&body.parent()!==context)continue e;return acceptParents[child.parent().id()]=!0,!0}}while((body=body.parent())&&body!==context)}return!1}results=results||[];if(!selector||typeof selector!="string")return results;context||(context=rootpQuery.world),context.type()==="world"&&(selector=selector.replace(/^world ?/,""));var selectorObj=Slick.parse(selector),expressions=selectorObj.expressions;return makeArray(context.children(filter,!0),results),results}}(),pQuery.contains=function(haystack,needle){return haystack.contains(needle)},pQuery.fn.extend({toArray:function(){return Array.prototype.slice.call(this,0)},get:function(num){return num==null?this.toArray():num<0?this[this.length+num]:this[num]}}),pQuery.fn.extend({world:new World,find:function(selector){var self=this,i,l;if(typeof selector!="string")return pQuery(selector).filter(function(){for(i=0,l=self.length;i<l;i++)if(pQuery.contains(self[i],this))return!0});var ret=this.pushStack("","find",selector),length,n,r;for(i=0,l=this.length;i<l;i++){length=ret.length,pQuery.find(selector,this[i],ret);if(i>0)for(n=length;n<ret.length;n++)for(r=0;r<length;r++)if(ret[r]===ret[n]){ret.splice(n--,1);break}}return ret},contains:function(){},add:function(selector,context){var set=typeof selector=="string"?pQuery(selector,context):pQuery.makeArray(selector&&Phyget.isBody(selector)?[selector]:selector),all=pQuery.merge(this.get(),set);return this.pushStack(!inWorld(set[0],this.world)||!inWorld(all[0],this.world)?all:pQuery.unique(all))},append:function(){return this.manip(arguments,function(body){this.add(body)})},appendTo:function(){return this.manip(arguments,function(body){this.addTo(body)})},manip:function(args,callback){var value=args[0],fragment=value.pquery?value[0]:value;if(this[0])for(var i=0,l=this.length;i<l;i++)callback.call(this[i],fragment);return this}}),pQuery.fn.extend({interact:function(types,sel,callback){var bodies,type=types;if(typeof types=="object"){for(type in types)this.interact(type,sel,types[type]);return this}sel==null&&callback==null?(callback=types,type="beforeAccel"):callback==null&&(callback=sel,sel=undefined,type=types);if(!callback)return this;if(!sel)bodies=pQuery.makeArray(this),this.world.registerInteraction(type,bodies,callback);else for(var i=0,l=this.length;i<l;++i)bodies=function(par){var p=pQuery(par);return function(){return pQuery.makeArray(p.find(sel))}}(this[i]),this.world.registerInteraction(type,bodies,callback,this[i]);return this},uninteract:function(){},accelerate:function(accel){var ch=this[0],x,y,z;if(typeof accel=="object"&&(x=accel.x)!==0||(y=accel.y)!==0||(z=accel.z)!==0||(x=accel)!==0||(y=arguments[1])!==0||(z=arguments[2])!==0)for(var i=this.length-1;i>-1;i--)ch=this[i],ch.accelerate(x,y,z);return this}}),pQuery.fn.extend({step:function(now){return this.world.step(now),this},timeStep:function(dt){return dt?(this.world.timeStep(dt),this):this.world.timeStep()},pause:function(){return this.world.pause(),this},unpause:function(){return this.world.unpause(),this},isPaused:function(){return this.world.isPaused()}}),rootpQuery=pQuery("world"),pQuery.fn.extend({id:function(value){return pQuery.isFunction(value)?pQuery.fn.id.call(this,value.call(this,0,this[0])):this[0]?this[0].id(value):null},addClass:function(value){if(pQuery.isFunction(value))return this.each(function(j){jQuery(this).addClass(value.call(this,j,this.classes()))});if(value&&typeof value=="string")for(var i=0,l=this.length;i<l;++i)this[i].addClass(value);return this},removeClass:function(value){if(pQuery.isFunction(value))return this.each(function(j){jQuery(this).removeClass(value.call(this,j,this.classes()))});if(value&&typeof value=="string")for(var i=0,l=this.length;i<l;++i)this[i].removeClass(value);return this},toggleClass:function(value,stateVal){if(pQuery.isFunction(value))return this.each(function(i){pQuery(this).toggleClass(value.call(this,i,this.className,stateVal),stateVal)});for(var i=0,l=this.length;i<l;++i)this[i].toggleClass(value,stateVal);return this},data:function(hash,val){if(val===undefined)return this[0]?this[0].data(hash):null;for(var i=0,l=this.length;i<l;++i)this[i].data(hash,val);return this},attr:function(key,val){if(val===undefined)return this[0]?this[0].attr(key):null;for(var i=0,l=this.length;i<l;++i)this[i].attr(key,val);return this}}),pQuery.fn.extend({type:function(){var first=this[0];return first&&first.type()},classes:function(){var first=this[0];return first&&first.classes()},parents:function(){var ret,i,l,n;for(i=0,l=this.length;i<l;i++)if(i==0)ret=this[i].parents();else{ret.push.apply(ret,this[i].parents());for(n=length;n<ret.length;n++)for(r=0;r<length;r++)if(ret[r]===ret[n]){ret.splice(n--,1);break}}return ret},position:function(pos){var first=this[0];if(typeof pos!="string"&&arguments.length>0){for(var i=this.length-1;i>-1;i--)first=this[i],first.position.apply(first,arguments);return this}return first&&first.position&&first.position()},velocity:function(vel){var first=this[0];if(typeof pos!="string"&&arguments.length>0){for(var i=this.length-1;i>-1;i--)first=this[i],first.velocity.apply(first,arguments);return this}return first&&first.velocity&&first.velocity()},dimensions:function(dims){var type=typeof dims,first=this[0];if(type==="object"){for(var i=0,l=this.length;i<l;++i)this[i].dimensions(dims.width,dims.height,dims.depth);return this}if(pQuery.isNumeric(dims)){dims={width:dims,height:arguments[1],depth:arguments[2]};for(var i=0,l=this.length;i<l;++i)this[i].dimensions(dims.width,dims.height,dims.depth);return this}return first.dimensions()}}),pQuery.fn.extend({hasClass:function(value){var first=this[0];return first&&first.hasClass.apply(first,arguments)}}),!function(){var proxyCache={};pQuery.fn.extend({on:function(evt,callback){var i,el;for(var i=this.length-1;i>-1;i--)el=this[i],el.subscribe(evt,callback);return this},off:function(evt,callback){var i,el;for(var i=this.length-1;i>-1;i--)el=this[i],el.unsubscribe(evt,callback);return this}})}(),pQuery});var Kinetic={};Kinetic.Filters={},Kinetic.Plugins={},Kinetic.Global={BUBBLE_WHITELIST:["mousedown","mousemove","mouseup","mouseover","mouseout","click","dblclick","touchstart","touchmove","touchend","tap","dbltap","dragstart","dragmove","dragend"],stages:[],idCounter:0,tempNodes:{},maxDragTimeInterval:20,drag:{moving:!1,offset:{x:0,y:0},lastDrawTime:0},warn:function(str){console&&console.warn&&console.warn("Kinetic warning: "+str)},_pullNodes:function(stage){var tempNodes=this.tempNodes;for(var key in tempNodes){var node=tempNodes[key];node.getStage()!==undefined&&node.getStage()._id===stage._id&&(stage._addId(node),stage._addName(node),this._removeTempNode(node))}},_addTempNode:function(node){this.tempNodes[node._id]=node},_removeTempNode:function(node){delete this.tempNodes[node._id]}},Kinetic.Transition=function(node,config){function addTween(c,attrs,obj,rootObj){for(var key in c)key!=="duration"&&key!=="easing"&&key!=="callback"&&(Kinetic.Type._isObject(c[key])?(obj[key]={},addTween(c[key],attrs[key],obj[key],rootObj)):that._add(that._getTween(attrs,key,c[key],obj,rootObj)))}this.node=node,this.config=config,this.tweens=[];var that=this,obj={};addTween(config,node.attrs,obj,obj);var finishedTweens=0;for(var n=0;n<this.tweens.length;n++){var tween=this.tweens[n];tween.onFinished=function(){finishedTweens++,finishedTweens>=that.tweens.length&&that.onFinished()}}},Kinetic.Transition.prototype={start:function(){for(var n=0;n<this.tweens.length;n++)this.tweens[n].start()},stop:function(){for(var n=0;n<this.tweens.length;n++)this.tweens[n].stop()},resume:function(){for(var n=0;n<this.tweens.length;n++)this.tweens[n].resume()},_onEnterFrame:function(){for(var n=0;n<this.tweens.length;n++)this.tweens[n].onEnterFrame()},_add:function(tween){this.tweens.push(tween)},_getTween:function(attrs,prop,val,obj,rootObj){var config=this.config,node=this.node,easing=config.easing;easing===undefined&&(easing="linear");var tween=new Kinetic.Tween(node,function(i){obj[prop]=i,node.setAttrs(rootObj)},Kinetic.Tweens[easing],attrs[prop],val,config.duration);return tween}},Kinetic.Filters.Grayscale=function(){var data=this.imageData.data;for(var i=0;i<data.length;i+=4){var brightness=.34*data[i]+.5*data[i+1]+.16*data[i+2];data[i]=brightness,data[i+1]=brightness,data[i+2]=brightness}},Kinetic.Type={_isElement:function(obj){return!!obj&&obj.nodeType==1},_isFunction:function(obj){return!!(obj&&obj.constructor&&obj.call&&obj.apply)},_isObject:function(obj){return!!obj&&obj.constructor==Object},_isArray:function(obj){return Object.prototype.toString.call(obj)=="[object Array]"},_isNumber:function(obj){return Object.prototype.toString.call(obj)=="[object Number]"},_isString:function(obj){return Object.prototype.toString.call(obj)=="[object String]"},_hasMethods:function(obj){var names=[];for(var key in obj)this._isFunction(obj[key])&&names.push(key);return names.length>0},_getXY:function(arg){if(this._isNumber(arg))return{x:arg,y:arg};if(this._isArray(arg)){if(arg.length===1){var val=arg[0];if(this._isNumber(val))return{x:val,y:val};if(this._isArray(val))return{x:val[0],y:val[1]};if(this._isObject(val))return val}else if(arg.length>=2)return{x:arg[0],y:arg[1]}}else if(this._isObject(arg))return arg;return{x:0,y:0}},_getSize:function(arg){if(this._isNumber(arg))return{width:arg,height:arg};if(this._isArray(arg))if(arg.length===1){var val=arg[0];if(this._isNumber(val))return{width:val,height:val};if(this._isArray(val)){if(val.length>=4)return{width:val[2],height:val[3]};if(val.length>=2)return{width:val[0],height:val[1]}}else if(this._isObject(val))return val}else{if(arg.length>=4)return{width:arg[2],height:arg[3]};if(arg.length>=2)return{width:arg[0],height:arg[1]}}else if(this._isObject(arg))return arg;return{width:0,height:0}},_getPoints:function(arg){if(arg===undefined)return[];if(this._isObject(arg[0]))return arg;var arr=[];for(var n=0;n<arg.length;n+=2)arr.push({x:arg[n],y:arg[n+1]});return arr},_getImage:function(arg,callback){if(!arg)callback(null);else if(this._isElement(arg))callback(arg);else if(this._isString(arg)){var imageObj=new Image;imageObj.onload=function(){callback(imageObj)},imageObj.src=arg}else if(arg.data){var canvas=document.createElement("canvas");canvas.width=arg.width,canvas.height=arg.height;var context=canvas.getContext("2d");context.putImageData(arg,0,0);var dataUrl=canvas.toDataURL(),imageObj=new Image;imageObj.onload=function(){callback(imageObj)},imageObj.src=dataUrl}else callback(null)}},Kinetic.Canvas=function(width,height){this.element=document.createElement("canvas"),this.context=this.element.getContext("2d"),this.element.width=width,this.element.height=height},Kinetic.Canvas.prototype={clear:function(){var context=this.getContext(),el=this.getElement();context.clearRect(0,0,el.width,el.height)},getElement:function(){return this.element},getContext:function(){return this.context},setWidth:function(width){this.element.width=width},setHeight:function(height){this.element.height=height},getWidth:function(){return this.element.width},getHeight:function(){return this.element.height},setSize:function(width,height){this.setWidth(width),this.setHeight(height)},strip:function(){var context=this.context;context.stroke=function(){},context.fill=function(){},context.fillRect=function(x,y,width,height){context.rect(x,y,width,height)},context.strokeRect=function(x,y,width,height){context.rect(x,y,width,height)},context.drawImage=function(){},context.fillText=function(){},context.strokeText=function(){}},toDataURL:function(mimeType,quality){try{return this.element.toDataURL(mimeType,quality)}catch(e){return this.element.toDataURL()}}},function(){var initializing=!1;Kinetic.Class=function(){},Kinetic.Class.extend=function(prop){function Class(){!initializing&&this.init&&this.init.apply(this,arguments)}var _super=this.prototype;initializing=!0;var prototype=new this;initializing=!1;for(var name in prop)prototype[name]=typeof prop[name]=="function"&&typeof _super[name]=="function"?function(name,fn){return function(){var tmp=this._super;this._super=_super[name];var ret=fn.apply(this,arguments);return this._super=tmp,ret}}(name,prop[name]):prop[name];return Class.prototype=prototype,Class.prototype.constructor=Class,Class.extend=arguments.callee,Class}}(),Kinetic.Tween=function(obj,propFunc,func,begin,finish,duration){this._listeners=[],this.addListener(this),this.obj=obj,this.propFunc=propFunc,this.begin=begin,this._pos=begin,this.setDuration(duration),this.isPlaying=!1,this._change=0,this.prevTime=0,this.prevPos=0,this.looping=!1,this._time=0,this._position=0,this._startTime=0,this._finish=0,this.name="",this.func=func,this.setFinish(finish)},Kinetic.Tween.prototype={setTime:function(t){this.prevTime=this._time,t>this.getDuration()?this.looping?(this.rewind(t-this._duration),this.update(),this.broadcastMessage("onLooped",{target:this,type:"onLooped"})):(this._time=this._duration,this.update(),this.stop(),this.broadcastMessage("onFinished",{target:this,type:"onFinished"})):t<0?(this.rewind(),this.update()):(this._time=t,this.update())},getTime:function(){return this._time},setDuration:function(d){this._duration=d===null||d<=0?1e5:d},getDuration:function(){return this._duration},setPosition:function(p){this.prevPos=this._pos,this.propFunc(p),this._pos=p,this.broadcastMessage("onChanged",{target:this,type:"onChanged"})},getPosition:function(t){return t===undefined&&(t=this._time),this.func(t,this.begin,this._change,this._duration)},setFinish:function(f){this._change=f-this.begin},getFinish:function(){return this.begin+this._change},start:function(){this.rewind(),this.startEnterFrame(),this.broadcastMessage("onStarted",{target:this,type:"onStarted"})},rewind:function(t){this.stop(),this._time=t===undefined?0:t,this.fixTime(),this.update()},fforward:function(){this._time=this._duration,this.fixTime(),this.update()},update:function(){this.setPosition(this.getPosition(this._time))},startEnterFrame:function(){this.stopEnterFrame(),this.isPlaying=!0,this.onEnterFrame()},onEnterFrame:function(){this.isPlaying&&this.nextFrame()},nextFrame:function(){this.setTime((this.getTimer()-this._startTime)/1e3)},stop:function(){this.stopEnterFrame(),this.broadcastMessage("onStopped",{target:this,type:"onStopped"})},stopEnterFrame:function(){this.isPlaying=!1},continueTo:function(finish,duration){this.begin=this._pos,this.setFinish(finish),this._duration!==undefined&&this.setDuration(duration),this.start()},resume:function(){this.fixTime(),this.startEnterFrame(),this.broadcastMessage("onResumed",{target:this,type:"onResumed"})},yoyo:function(){this.continueTo(this.begin,this._time)},addListener:function(o){return this.removeListener(o),this._listeners.push(o)},removeListener:function(o){var a=this._listeners,i=a.length;while(i--)if(a[i]==o)return a.splice(i,1),!0;return!1},broadcastMessage:function(){var arr=[];for(var i=0;i<arguments.length;i++)arr.push(arguments[i]);var e=arr.shift(),a=this._listeners,l=a.length;for(var i=0;i<l;i++)a[i][e]&&a[i][e].apply(a[i],arr)},fixTime:function(){this._startTime=this.getTimer()-this._time*1e3},getTimer:function(){return(new Date).getTime()-this._time}},Kinetic.Tweens={"back-ease-in":function(t,b,c,d,a,p){var s=1.70158;return c*(t/=d)*t*((s+1)*t-s)+b},"back-ease-out":function(t,b,c,d,a,p){var s=1.70158;return c*((t=t/d-1)*t*((s+1)*t+s)+1)+b},"back-ease-in-out":function(t,b,c,d,a,p){var s=1.70158;return(t/=d/2)<1?c/2*t*t*(((s*=1.525)+1)*t-s)+b:c/2*((t-=2)*t*(((s*=1.525)+1)*t+s)+2)+b},"elastic-ease-in":function(t,b,c,d,a,p){var s=0;return t===0?b:(t/=d)==1?b+c:(p||(p=d*.3),!a||a<Math.abs(c)?(a=c,s=p/4):s=p/(2*Math.PI)*Math.asin(c/a),-(a*Math.pow(2,10*(t-=1))*Math.sin((t*d-s)*2*Math.PI/p))+b)},"elastic-ease-out":function(t,b,c,d,a,p){var s=0;return t===0?b:(t/=d)==1?b+c:(p||(p=d*.3),!a||a<Math.abs(c)?(a=c,s=p/4):s=p/(2*Math.PI)*Math.asin(c/a),a*Math.pow(2,-10*t)*Math.sin((t*d-s)*2*Math.PI/p)+c+b)},"elastic-ease-in-out":function(t,b,c,d,a,p){var s=0;return t===0?b:(t/=d/2)==2?b+c:(p||(p=d*.3*1.5),!a||a<Math.abs(c)?(a=c,s=p/4):s=p/(2*Math.PI)*Math.asin(c/a),t<1?-0.5*a*Math.pow(2,10*(t-=1))*Math.sin((t*d-s)*2*Math.PI/p)+b:a*Math.pow(2,-10*(t-=1))*Math.sin((t*d-s)*2*Math.PI/p)*.5+c+b)},"bounce-ease-out":function(t,b,c,d){return(t/=d)<1/2.75?c*7.5625*t*t+b:t<2/2.75?c*(7.5625*(t-=1.5/2.75)*t+.75)+b:t<2.5/2.75?c*(7.5625*(t-=2.25/2.75)*t+.9375)+b:c*(7.5625*(t-=2.625/2.75)*t+.984375)+b},"bounce-ease-in":function(t,b,c,d){return c-Kinetic.Tweens["bounce-ease-out"](d-t,0,c,d)+b},"bounce-ease-in-out":function(t,b,c,d){return t<d/2?Kinetic.Tweens["bounce-ease-in"](t*2,0,c,d)*.5+b:Kinetic.Tweens["bounce-ease-out"](t*2-d,0,c,d)*.5+c*.5+b},"ease-in":function(t,b,c,d){return c*(t/=d)*t+b},"ease-out":function(t,b,c,d){return-c*(t/=d)*(t-2)+b},"ease-in-out":function(t,b,c,d){return(t/=d/2)<1?c/2*t*t+b:-c/2*(--t*(t-2)-1)+b},"strong-ease-in":function(t,b,c,d){return c*(t/=d)*t*t*t*t+b},"strong-ease-out":function(t,b,c,d){return c*((t=t/d-1)*t*t*t*t+1)+b},"strong-ease-in-out":function(t,b,c,d){return(t/=d/2)<1?c/2*t*t*t*t*t+b:c/2*((t-=2)*t*t*t*t+2)+b},linear:function(t,b,c,d){return c*t/d+b}},Kinetic.Transform=function(){this.m=[1,0,0,1,0,0]},Kinetic.Transform.prototype={translate:function(x,y){this.m[4]+=this.m[0]*x+this.m[2]*y,this.m[5]+=this.m[1]*x+this.m[3]*y},scale:function(sx,sy){this.m[0]*=sx,this.m[1]*=sx,this.m[2]*=sy,this.m[3]*=sy},rotate:function(rad){var c=Math.cos(rad),s=Math.sin(rad),m11=this.m[0]*c+this.m[2]*s,m12=this.m[1]*c+this.m[3]*s,m21=this.m[0]*-s+this.m[2]*c,m22=this.m[1]*-s+this.m[3]*c;this.m[0]=m11,this.m[1]=m12,this.m[2]=m21,this.m[3]=m22},getTranslation:function(){return{x:this.m[4],y:this.m[5]}},multiply:function(matrix){var m11=this.m[0]*matrix.m[0]+this.m[2]*matrix.m[1],m12=this.m[1]*matrix.m[0]+this.m[3]*matrix.m[1],m21=this.m[0]*matrix.m[2]+this.m[2]*matrix.m[3],m22=this.m[1]*matrix.m[2]+this.m[3]*matrix.m[3],dx=this.m[0]*matrix.m[4]+this.m[2]*matrix.m[5]+this.m[4],dy=this.m[1]*matrix.m[4]+this.m[3]*matrix.m[5]+this.m[5];this.m[0]=m11,this.m[1]=m12,this.m[2]=m21,this.m[3]=m22,this.m[4]=dx,this.m[5]=dy},invert:function(){var d=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),m0=this.m[3]*d,m1=-this.m[1]*d,m2=-this.m[2]*d,m3=this.m[0]*d,m4=d*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),m5=d*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);this.m[0]=m0,this.m[1]=m1,this.m[2]=m2,this.m[3]=m3,this.m[4]=m4,this.m[5]=m5},getMatrix:function(){return this.m}},Kinetic.Animation=function(config){config||(config={});for(var key in config)this[key]=config[key];this.id=Kinetic.Animation.animIdCounter++},Kinetic.Animation.animations=[],Kinetic.Animation.animIdCounter=0,Kinetic.Animation.animRunning=!1,Kinetic.Animation.frame={time:0,timeDiff:0,lastTime:(new Date).getTime()},Kinetic.Animation._addAnimation=function(anim){this.animations.push(anim)},Kinetic.Animation._removeAnimation=function(anim){var id=anim.id,animations=this.animations;for(var n=0;n<animations.length;n++)if(animations[n].id===id)return this.animations.splice(n,1),!1},Kinetic.Animation._runFrames=function(){var nodes={};for(var n=0;n<this.animations.length;n++){var anim=this.animations[n];anim.node&&anim.node._id!==undefined&&(nodes[anim.node._id]=anim.node),anim.func&&anim.func(this.frame)}for(var key in nodes)nodes[key].draw()},Kinetic.Animation._updateFrameObject=function(){var time=(new Date).getTime();this.frame.timeDiff=time-this.frame.lastTime,this.frame.lastTime=time,this.frame.time+=this.frame.timeDiff},Kinetic.Animation._animationLoop=function(){if(this.animations.length>0){this._updateFrameObject(),this._runFrames();var that=this;requestAnimFrame(function(){that._animationLoop()})}else this.animRunning=!1,this.frame.lastTime=0},Kinetic.Animation._handleAnimation=function(){var that=this;this.animRunning?this.frame.lastTime=0:(this.animRunning=!0,that._animationLoop())},requestAnimFrame=function(callback){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)}}(),Kinetic.Node=Kinetic.Class.extend({init:function(config){this.defaultNodeAttrs={visible:!0,listening:!0,name:undefined,alpha:1,x:0,y:0,scale:{x:1,y:1},rotation:0,offset:{x:0,y:0},dragConstraint:"none",dragBounds:{},draggable:!1,dragThrottle:80},this.setDefaultAttrs(this.defaultNodeAttrs),this.eventListeners={},this.lastDragTime=0,this.transAnim=new Kinetic.Animation,this.setAttrs(config),this.on("draggableChange.kinetic",function(){this._onDraggableChange()});var that=this;this.on("idChange.kinetic",function(evt){var stage=that.getStage();stage&&(stage._removeId(evt.oldVal),stage._addId(that))}),this.on("nameChange.kinetic",function(evt){var stage=that.getStage();stage&&(stage._removeName(evt.oldVal,that._id),stage._addName(that))}),this._onDraggableChange()},on:function(typesStr,handler){var types=typesStr.split(" ");for(var n=0;n<types.length;n++){var type=types[n],event=type,parts=event.split("."),baseEvent=parts[0],name=parts.length>1?parts[1]:"";this.eventListeners[baseEvent]||(this.eventListeners[baseEvent]=[]),this.eventListeners[baseEvent].push({name:name,handler:handler})}},off:function(typesStr){var types=typesStr.split(" ");for(var n=0;n<types.length;n++){var type=types[n],event=type,parts=event.split("."),baseEvent=parts[0];if(this.eventListeners[baseEvent]&&parts.length>1){var name=parts[1];for(var i=0;i<this.eventListeners[baseEvent].length;i++)if(this.eventListeners[baseEvent][i].name===name){this.eventListeners[baseEvent].splice(i,1);if(this.eventListeners[baseEvent].length===0){delete this.eventListeners[baseEvent];break}i--}}else delete this.eventListeners[baseEvent]}},getAttrs:function(){return this.attrs},setDefaultAttrs:function(config){this.attrs===undefined&&(this.attrs={});if(config)for(var key in config)this.attrs[key]===undefined&&(this.attrs[key]=config[key])},setAttrs:function(config){var type=Kinetic.Type,that=this;if(config!==undefined){function setAttrs(obj,c,level){for(var key in c){var val=c[key],oldVal=obj[key];level===0&&that._fireBeforeChangeEvent(key,oldVal,val),obj[key]===undefined&&val!==undefined&&(obj[key]={});if(type._isObject(val)&&!type._isArray(val)&&!type._isElement(val)&&!type._hasMethods(val))Kinetic.Type._isObject(obj[key])||(obj[key]={}),setAttrs(obj[key],val,level+1);else switch(key){case"rotationDeg":that._setAttr(obj,"rotation",c[key]*Math.PI/180),key="rotation";break;case"offset":var pos=type._getXY(val);that._setAttr(obj[key],"x",pos.x),that._setAttr(obj[key],"y",pos.y);break;case"scale":var pos=type._getXY(val);that._setAttr(obj[key],"x",pos.x),that._setAttr(obj[key],"y",pos.y);break;case"points":that._setAttr(obj,key,type._getPoints(val));break;case"crop":var pos=type._getXY(val),size=type._getSize(val);that._setAttr(obj[key],"x",pos.x),that._setAttr(obj[key],"y",pos.y),that._setAttr(obj[key],"width",size.width),that._setAttr(obj[key],"height",size.height);break;default:that._setAttr(obj,key,val)}level===0&&that._fireChangeEvent(key,oldVal,val)}}setAttrs(this.attrs,config,0)}},isVisible:function(){return this.attrs.visible&&this.getParent()&&!this.getParent().isVisible()?!1:this.attrs.visible},show:function(){this.setAttrs({visible:!0})},hide:function(){this.setAttrs({visible:!1})},getZIndex:function(){return this.index},getAbsoluteZIndex:function(){function addChildren(children){var nodes=[];for(var n=0;n<children.length;n++){var child=children[n];index++,child.nodeType!=="Shape"&&(nodes=nodes.concat(child.getChildren())),child._id===that._id&&(n=children.length)}nodes.length>0&&nodes[0].getLevel()<=level&&addChildren(nodes)}var level=this.getLevel(),stage=this.getStage(),that=this,index=0;return that.nodeType!=="Stage"&&addChildren(that.getStage().getChildren()),index},getLevel:function(){var level=0,parent=this.parent;while(parent)level++,parent=parent.parent;return level},setPosition:function(){var pos=Kinetic.Type._getXY(Array.prototype.slice.call(arguments));this.setAttrs(pos)},getPosition:function(){return{x:this.attrs.x,y:this.attrs.y}},getAbsolutePosition:function(){var trans=this.getAbsoluteTransform(),o=this.getOffset();return trans.translate(o.x,o.y),trans.getTranslation()},setAbsolutePosition:function(){var pos=Kinetic.Type._getXY(Array.prototype.slice.call(arguments)),trans=this._clearTransform();this.attrs.x=trans.x,this.attrs.y=trans.y,delete trans.x,delete trans.y;var it=this.getAbsoluteTransform();it.invert(),it.translate(pos.x,pos.y),pos={x:this.attrs.x+it.getTranslation().x,y:this.attrs.y+it.getTranslation().y},this.setPosition(pos.x,pos.y),this._setTransform(trans)},move:function(){var pos=Kinetic.Type._getXY(Array.prototype.slice.call(arguments)),x=this.getX(),y=this.getY();pos.x!==undefined&&(x+=pos.x),pos.y!==undefined&&(y+=pos.y),this.setAttrs({x:x,y:y})},getRotationDeg:function(){return this.attrs.rotation*180/Math.PI},rotate:function(theta){this.setAttrs({rotation:this.getRotation()+theta})},rotateDeg:function(deg){this.setAttrs({rotation:this.getRotation()+deg*Math.PI/180})},moveToTop:function(){var index=this.index;this.parent.children.splice(index,1),this.parent.children.push(this),this.parent._setChildrenIndices()},moveUp:function(){var index=this.index;this.parent.children.splice(index,1),this.parent.children.splice(index+1,0,this),this.parent._setChildrenIndices()},moveDown:function(){var index=this.index;index>0&&(this.parent.children.splice(index,1),this.parent.children.splice(index-1,0,this),this.parent._setChildrenIndices())},moveToBottom:function(){var index=this.index;this.parent.children.splice(index,1),this.parent.children.unshift(this),this.parent._setChildrenIndices()},setZIndex:function(zIndex){var index=this.index;this.parent.children.splice(index,1),this.parent.children.splice(zIndex,0,this),this.parent._setChildrenIndices()},getAbsoluteAlpha:function(){var absAlpha=1,node=this;while(node.nodeType!=="Stage")absAlpha*=node.attrs.alpha,node=node.parent;return absAlpha},isDragging:function(){var go=Kinetic.Global;return go.drag.node!==undefined&&go.drag.node._id===this._id&&go.drag.moving},moveTo:function(newContainer){var parent=this.parent;parent.children.splice(this.index,1),parent._setChildrenIndices(),newContainer.children.push(this),this.index=newContainer.children.length-1,this.parent=newContainer,newContainer._setChildrenIndices()},getParent:function(){return this.parent},getLayer:function(){return this.nodeType==="Layer"?this:this.getParent().getLayer()},getStage:function(){return this.nodeType!=="Stage"&&this.getParent()?this.getParent().getStage():this.nodeType==="Stage"?this:undefined},simulate:function(eventType){this._handleEvent(eventType,{})},transitionTo:function(config){var a=Kinetic.Animation;a._removeAnimation(this.transAnim);var node=this.nodeType==="Stage"?this:this.getLayer(),that=this,trans=new Kinetic.Transition(this,config);return this.transAnim.func=function(){trans._onEnterFrame()},this.transAnim.node=node,a._addAnimation(this.transAnim),trans.onFinished=function(){a._removeAnimation(that.transAnim),that.transAnim.node.draw(),config.callback&&config.callback()},trans.start(),a._handleAnimation(),trans},getAbsoluteTransform:function(){var am=new Kinetic.Transform,family=[],parent=this.parent;family.unshift(this);while(parent)family.unshift(parent),parent=parent.parent;for(var n=0;n<family.length;n++){var node=family[n],m=node.getTransform();am.multiply(m)}return am},getTransform:function(){var m=new Kinetic.Transform;return(this.attrs.x!==0||this.attrs.y!==0)&&m.translate(this.attrs.x,this.attrs.y),this.attrs.rotation!==0&&m.rotate(this.attrs.rotation),(this.attrs.scale.x!==1||this.attrs.scale.y!==1)&&m.scale(this.attrs.scale.x,this.attrs.scale.y),this.attrs.offset&&(this.attrs.offset.x!==0||this.attrs.offset.y!==0)&&m.translate(-1*this.attrs.offset.x,-1*this.attrs.offset.y),m},clone:function(obj){var classType=this.shapeType||this.nodeType,node=new Kinetic[classType](this.attrs);for(var key in this.eventListeners){var allListeners=this.eventListeners[key];for(var n=0;n<allListeners.length;n++){var listener=allListeners[n];listener.name.indexOf("kinetic")<0&&(node.eventListeners[key]||(node.eventListeners[key]=[]),node.eventListeners[key].push(listener))}}return node.setAttrs(obj),node},saveImageData:function(width,height){try{var canvas;if(width&&height)canvas=new Kinetic.Canvas(width,height);else{var stage=this.getStage();canvas=stage.bufferCanvas}var context=canvas.getContext();canvas.clear(),this._draw(canvas);var imageData=context.getImageData(0,0,canvas.getWidth(),canvas.getHeight());this.imageData=imageData}catch(e){Kinetic.Global.warn("Image data could not saved because canvas is dirty.")}},clearImageData:function(){delete this.imageData},getImageData:function(){return this.imageData},toDataURL:function(config){var mimeType=config&&config.mimeType?config.mimeType:null,quality=config&&config.quality?config.quality:null,canvas;config&&config.width&&config.height?canvas=new Kinetic.Canvas(config.width,config.height):canvas=this.getStage().bufferCanvas;var context=canvas.getContext();return canvas.clear(),this._draw(canvas),canvas.toDataURL(mimeType,quality)},toImage:function(config){Kinetic.Type._getImage(this.toDataURL(config),function(img){config.callback(img)})},_clearTransform:function(){var trans={x:this.attrs.x,y:this.attrs.y,rotation:this.attrs.rotation,scale:{x:this.attrs.scale.x,y:this.attrs.scale.y},offset:{x:this.attrs.offset.x,y:this.attrs.offset.y}};return this.attrs.x=0,this.attrs.y=0,this.attrs.rotation=0,this.attrs.scale={x:1,y:1},this.attrs.offset={x:0,y:0},trans},_setTransform:function(trans){for(var key in trans)this.attrs[key]=trans[key]},_setImageData:function(imageData){imageData&&imageData.data&&(this.imageData=imageData)},_fireBeforeChangeEvent:function(attr,oldVal,newVal){this._handleEvent("before"+attr.toUpperCase()+"Change",{oldVal:oldVal,newVal:newVal})},_fireChangeEvent:function(attr,oldVal,newVal){this._handleEvent(attr+"Change",{oldVal:oldVal,newVal:newVal})},_setAttr:function(obj,attr,val){val!==undefined&&(obj===undefined&&(obj={}),obj[attr]=val)},_listenDrag:function(){this._dragCleanup();var go=Kinetic.Global,that=this;this.on("mousedown.kinetic touchstart.kinetic",function(evt){that._initDrag()})},_initDrag:function(){var go=Kinetic.Global,stage=this.getStage(),pos=stage.getUserPosition();if(pos){var m=this.getTransform().getTranslation(),am=this.getAbsoluteTransform().getTranslation(),ap=this.getAbsolutePosition();go.drag.node=this,go.drag.offset.x=pos.x-ap.x,go.drag.offset.y=pos.y-ap.y}},_onDraggableChange:function(){if(this.attrs.draggable)this._listenDrag();else{this._dragCleanup();var stage=this.getStage(),go=Kinetic.Global;stage&&go.drag.node&&go.drag.node._id===this._id&&stage._endDrag()}},_dragCleanup:function(){this.off("mousedown.kinetic"),this.off("touchstart.kinetic")},_handleEvent:function(eventType,evt){this.nodeType==="Shape"&&(evt.shape=this);var stage=this.getStage(),mover=stage?stage.mouseoverShape:null,mout=stage?stage.mouseoutShape:null,el=this.eventListeners,okayToRun=!0;eventType==="mouseover"&&mout&&mout._id===this._id?okayToRun=!1:eventType==="mouseout"&&mover&&mover._id===this._id&&(okayToRun=!1);if(okayToRun){if(el[eventType]){var events=el[eventType];for(var i=0;i<events.length;i++)events[i].handler.apply(this,[evt])}stage&&mover&&mout&&(stage.mouseoverShape=mover.parent,stage.mouseoutShape=mout.parent),Kinetic.Global.BUBBLE_WHITELIST.indexOf(eventType)>=0&&!evt.cancelBubble&&this.parent&&this._handleEvent.call(this.parent,eventType,evt)}}}),Kinetic.Node.addSetters=function(constructor,arr){for(var n=0;n<arr.length;n++){var attr=arr[n];this._addSetter(constructor,attr)}},Kinetic.Node.addGetters=function(constructor,arr){for(var n=0;n<arr.length;n++){var attr=arr[n];this._addGetter(constructor,attr)}},Kinetic.Node.addGettersSetters=function(constructor,arr){this.addSetters(constructor,arr),this.addGetters(constructor,arr)},Kinetic.Node._addSetter=function(constructor,attr){var that=this,method="set"+attr.charAt(0).toUpperCase()+attr.slice(1);constructor.prototype[method]=function(){arguments.length==1?arg=arguments[0]:arg=Array.prototype.slice.call(arguments);var obj={};obj[attr]=arg,this.setAttrs(obj)}},Kinetic.Node._addGetter=function(constructor,attr){var that=this,method="get"+attr.charAt(0).toUpperCase()+attr.slice(1);constructor.prototype[method]=function(arg){return this.attrs[attr]}},Kinetic.Node.addGettersSetters(Kinetic.Node,["x","y","scale","detectionType","rotation","alpha","name","id","offset","draggable","dragConstraint","dragBounds","listening","dragThrottle"]),Kinetic.Node.addSetters(Kinetic.Node,["rotationDeg"]),Kinetic.Container=Kinetic.Node.extend({init:function(config){this.children=[],this._super(config)},getChildren:function(){return this.children},removeChildren:function(){while(this.children.length>0)this.remove(this.children[0])},add:function(child){child._id=Kinetic.Global.idCounter++,child.index=this.children.length,child.parent=this,this.children.push(child);var stage=child.getStage();if(!stage)Kinetic.Global._addTempNode(child);else{stage._addId(child),stage._addName(child);var go=Kinetic.Global;go._pullNodes(stage)}return this._add!==undefined&&this._add(child),this},remove:function(child){if(child&&child.index!==undefined&&this.children[child.index]._id==child._id){var stage=this.getStage();stage&&(stage._removeId(child.getId()),stage._removeName(child.getName(),child._id)),Kinetic.Global._removeTempNode(child),this.children.splice(child.index,1),this._setChildrenIndices();while(child.children&&child.children.length>0)child.remove(child.children[0]);this._remove!==undefined&&this._remove(child)}return this},get:function(selector){var stage=this.getStage(),arr,key=selector.slice(1);if(selector.charAt(0)==="#")arr=stage.ids[key]!==undefined?[stage.ids[key]]:[];else{if(selector.charAt(0)!==".")return selector==="Shape"||selector==="Group"||selector==="Layer"?this._getNodes(selector):!1;arr=stage.names[key]!==undefined?stage.names[key]:[]}var retArr=[];for(var n=0;n<arr.length;n++){var node=arr[n];this.isAncestorOf(node)&&retArr.push(node)}return retArr},isAncestorOf:function(node){if(this.nodeType==="Stage")return!0;var parent=node.getParent();while(parent){if(parent._id===this._id)return!0;parent=parent.getParent()}return!1},getIntersections:function(){var pos=Kinetic.Type._getXY(Array.prototype.slice.call(arguments)),arr=[],shapes=this.get("Shape");for(var n=0;n<shapes.length;n++){var shape=shapes[n];shape.isVisible()&&shape.intersects(pos)&&arr.push(shape)}return arr},_getNodes:function(sel){function traverse(cont){var children=cont.getChildren();for(var n=0;n<children.length;n++){var child=children[n];child.nodeType===sel?arr.push(child):child.nodeType!=="Shape"&&traverse(child)}}var arr=[];return traverse(this),arr},_drawChildren:function(canvas){var stage=this.getStage(),children=this.children;for(var n=0;n<children.length;n++){var child=children[n];child.nodeType==="Shape"?child.isVisible()&&stage.isVisible()&&child._draw(canvas):child.draw(canvas)}},_setChildrenIndices:function(){for(var n=0;n<this.children.length;n++)this.children[n].index=n}}),Kinetic.Stage=Kinetic.Container.extend({init:function(config){this.setDefaultAttrs({width:400,height:200}),typeof config.container=="string"&&(config.container=document.getElementById(config.container)),this._super(config),this._setStageDefaultProperties(),this._id=Kinetic.Global.idCounter++,this._buildDOM(),this._bindContentEvents(),this.on("widthChange.kinetic",function(){this._resizeDOM()}),this.on("heightChange.kinetic",function(){this._resizeDOM()});var go=Kinetic.Global;go.stages.push(this),this._addId(this),this._addName(this)},onFrame:function(func){this.anim.func=func},start:function(){if(!this.animRunning){var a=Kinetic.Animation;a._addAnimation(this.anim),a._handleAnimation(),this.animRunning=!0}},stop:function(){Kinetic.Animation._removeAnimation(this.anim),this.animRunning=!1},draw:function(canvas){this._draw(canvas)},setSize:function(){var size=Kinetic.Type._getSize(Array.prototype.slice.call(arguments));this.setAttrs(size)},getSize:function(){return{width:this.attrs.width,height:this.attrs.height}},clear:function(){var layers=this.children;for(var n=0;n<layers.length;n++)layers[n].clear()},toJSON:function(){function addNode(node){var obj={};obj.attrs={};for(var key in node.attrs){var val=node.attrs[key];!type._isFunction(val)&&!type._isElement(val)&&!type._hasMethods(val)&&(obj.attrs[key]=val)}obj.nodeType=node.nodeType,obj.shapeType=node.shapeType;if(node.nodeType!=="Shape"){obj.children=[];var children=node.getChildren();for(var n=0;n<children.length;n++){var child=children[n];obj.children.push(addNode(child))}}return obj}var type=Kinetic.Type;return JSON.stringify(addNode(this))},reset:function(){this.removeChildren(),this._setStageDefaultProperties(),this.setAttrs(this.defaultNodeAttrs)},load:function(json){function loadNode(node,obj){var children=obj.children;if(children!==undefined)for(var n=0;n<children.length;n++){var child=children[n],type;child.nodeType==="Shape"?child.shapeType===undefined?type="Shape":type=child.shapeType:type=child.nodeType;var no=new Kinetic[type](child.attrs);node.add(no),loadNode(no,child)}}this.reset();var obj=JSON.parse(json);this.attrs=obj.attrs,loadNode(this,obj),this.draw()},getMousePosition:function(evt){return this.mousePos},getTouchPosition:function(evt){return this.touchPos},getUserPosition:function(evt){return this.getTouchPosition()||this.getMousePosition()},getContainer:function(){return this.attrs.container},getStage:function(){return this},getDOM:function(){return this.content},toDataURL:function(config){function drawLayer(n){var layer=layers[n],layerUrl=layer.getCanvas().toDataURL(mimeType,quality),imageObj=new Image;imageObj.onload=function(){context.drawImage(imageObj,0,0),n<layers.length-1?drawLayer(n+1):config.callback(canvas.toDataURL(mimeType,quality))},imageObj.src=layerUrl}var mimeType=config&&config.mimeType?config.mimeType:null,quality=config&&config.quality?config.quality:null,width=config&&config.width?config.width:this.attrs.width,height=config&&config.height?config.height:this.attrs.height,canvas=new Kinetic.Canvas(width,height),context=canvas.getContext(),layers=this.children;drawLayer(0)},toImage:function(config){this.toDataURL({callback:function(dataUrl){Kinetic.Type._getImage(dataUrl,function(img){config.callback(img)})}})},_resizeDOM:function(){var width=this.attrs.width,height=this.attrs.height;this.content.style.width=width+"px",this.content.style.height=height+"px",this.bufferCanvas.setSize(width,height),this.pathCanvas.setSize(width,height);var layers=this.children;for(var n=0;n<layers.length;n++){var layer=layers[n];layer.getCanvas().setSize(width,height),layer.draw()}},_remove:function(layer){try{this.content.removeChild(layer.canvas.element)}catch(e){}},_add:function(layer){layer.canvas.setSize(this.attrs.width,this.attrs.height),layer.draw(),this.content.appendChild(layer.canvas.element),layer.lastDrawTime=0},_detectEvent:function(shape,evt){var isDragging=Kinetic.Global.drag.moving,go=Kinetic.Global,pos=this.getUserPosition(),el=shape.eventListeners,that=this;this.targetShape&&shape._id===this.targetShape._id&&(this.targetFound=!0);if(shape.isVisible()&&pos!==undefined&&shape.intersects(pos)){if(!isDragging&&this.mouseDown)return this.mouseDown=!1,this.clickStart=!0,shape._handleEvent("mousedown",evt),!0;if(this.mouseUp)return this.mouseUp=!1,shape._handleEvent("mouseup",evt),this.clickStart&&(!go.drag.moving||!go.drag.node)&&(shape._handleEvent("click",evt),this.inDoubleClickWindow&&shape._handleEvent("dblclick",evt),this.inDoubleClickWindow=!0,setTimeout(function(){that.inDoubleClickWindow=!1},this.dblClickWindow)),!0;if(!isDragging&&this.touchStart&&!this.touchMove)return this.touchStart=!1,this.tapStart=!0,shape._handleEvent("touchstart",evt),!0;if(this.touchEnd)return this.touchEnd=!1,shape._handleEvent("touchend",evt),this.tapStart&&(!go.drag.moving||!go.drag.node)&&(shape._handleEvent("tap",evt),this.inDoubleClickWindow&&shape._handleEvent("dbltap",evt),this.inDoubleClickWindow=!0,setTimeout(function(){that.inDoubleClickWindow=!1},this.dblClickWindow)),!0;if(!isDragging&&this.touchMove)return shape._handleEvent("touchmove",evt),!0;if(!isDragging&&this._isNewTarget(shape,evt))return this.mouseoutShape&&(this.mouseoverShape=shape,this.mouseoutShape._handleEvent("mouseout",evt),this.mouseoverShape=undefined),shape._handleEvent("mouseover",evt),this._setTarget(shape),!0;if(!isDragging&&this.mouseMove)return shape._handleEvent("mousemove",evt),!0}else if(!isDragging&&this.targetShape&&this.targetShape._id===shape._id)return this._setTarget(undefined),this.mouseoutShape=shape,!0;return!1},_setTarget:function(shape){this.targetShape=shape,this.targetFound=!0},_isNewTarget:function(shape,evt){if(!this.targetShape||!this.targetFound&&shape._id!==this.targetShape._id){if(this.targetShape){var oldEl=this.targetShape.eventListeners;oldEl&&(this.mouseoutShape=this.targetShape)}return!0}return!1},_traverseChildren:function(obj,evt){var children=obj.children;for(var i=children.length-1;i>=0;i--){var child=children[i];if(child.getListening())if(child.nodeType==="Shape"){var exit=this._detectEvent(child,evt);if(exit)return!0}else{var exit=this._traverseChildren(child,evt);if(exit)return!0}}return!1},_handleStageEvent:function(evt){var go=Kinetic.Global;evt||(evt=window.event),this._setMousePosition(evt),this._setTouchPosition(evt),this.pathCanvas.clear(),this.targetFound=!1;var shapeDetected=!1;for(var n=this.children.length-1;n>=0;n--){var layer=this.children[n];if(layer.isVisible()&&n>=0&&layer.getListening()&&this._traverseChildren(layer,evt)){shapeDetected=!0;break}}!shapeDetected&&this.mouseoutShape&&(this.mouseoutShape._handleEvent("mouseout",evt),this.mouseoutShape=undefined)},_bindContentEvents:function(){var go=Kinetic.Global,that=this,events=["mousedown","mousemove","mouseup","mouseover","mouseout","touchstart","touchmove","touchend"];for(var n=0;n<events.length;n++){var pubEvent=events[n];(function(){var event=pubEvent;that.content.addEventListener(event,function(evt){that["_"+event](evt)},!1)})()}},_mouseover:function(evt){this._handleStageEvent(evt)},_mouseout:function(evt){var targetShape=this.targetShape;targetShape&&(targetShape._handleEvent("mouseout",evt),this.targetShape=undefined),this.mousePos=undefined,this._endDrag(evt)},_mousemove:function(evt){this.mouseDown=!1,this.mouseUp=!1,this.mouseMove=!0,this._handleStageEvent(evt),this._startDrag(evt)},_mousedown:function(evt){this.mouseDown=!0,this.mouseUp=!1,this.mouseMove=!1,this._handleStageEvent(evt),this.attrs.draggable&&this._initDrag()},_mouseup:function(evt){this.mouseDown=!1,this.mouseUp=!0,this.mouseMove=!1,this._handleStageEvent(evt),this.clickStart=!1,this._endDrag(evt)},_touchstart:function(evt){evt.preventDefault(),this.touchStart=!0,this.touchEnd=!1,this.touchMove=!1,this._handleStageEvent(evt),this.attrs.draggable&&this._initDrag()},_touchend:function(evt){this.touchStart=!1,this.touchEnd=!0,this.touchMove=!1,this._handleStageEvent(evt),this.tapStart=!1,this._endDrag(evt)},_touchmove:function(evt){evt.preventDefault(),this.touchEnd=!1,this.touchMove=!0,this._handleStageEvent(evt),this._startDrag(evt)},_setMousePosition:function(evt){var mouseX=evt.offsetX||evt.clientX-this._getContentPosition().left+window.pageXOffset,mouseY=evt.offsetY||evt.clientY-this._getContentPosition().top+window.pageYOffset;this.mousePos={x:mouseX,y:mouseY}},_setTouchPosition:function(evt){if(evt.touches!==undefined&&evt.touches.length===1){var touch=evt.touches[0],touchX=touch.clientX-this._getContentPosition().left+window.pageXOffset,touchY=touch.clientY-this._getContentPosition().top+window.pageYOffset;this.touchPos={x:touchX,y:touchY}}},_getContentPosition:function(){var rect=this.content.getBoundingClientRect(),root=document.documentElement;return{top:rect.top+root.scrollTop,left:rect.left+root.scrollLeft}},_endDrag:function(evt){var go=Kinetic.Global;go.drag.node&&go.drag.moving&&(go.drag.moving=!1,go.drag.node._handleEvent("dragend",evt)),go.drag.node=undefined},_startDrag:function(evt){var that=this,go=Kinetic.Global,node=go.drag.node;if(node){var dragThrottle=node.attrs.dragThrottle,time=(new Date).getTime(),timeDiff=time-node.lastDragTime,tt=1e3/dragThrottle;if(timeDiff>=tt||dragThrottle>200){var pos=that.getUserPosition(),dc=node.attrs.dragConstraint,db=node.attrs.dragBounds,lastNodePos={x:node.attrs.x,y:node.attrs.y},newNodePos={x:pos.x-go.drag.offset.x,y:pos.y-go.drag.offset.y};db.left!==undefined&&newNodePos.x<db.left&&(newNodePos.x=db.left),db.right!==undefined&&newNodePos.x>db.right&&(newNodePos.x=db.right),db.top!==undefined&&newNodePos.y<db.top&&(newNodePos.y=db.top),db.bottom!==undefined&&newNodePos.y>db.bottom&&(newNodePos.y=db.bottom),node.setAbsolutePosition(newNodePos),dc==="horizontal"?node.attrs.y=lastNodePos.y:dc==="vertical"&&(node.attrs.x=lastNodePos.x),go.drag.node.nodeType==="Stage"?go.drag.node.draw():go.drag.node.getLayer().draw(),go.drag.moving||(go.drag.moving=!0,go.drag.node._handleEvent("dragstart",evt)),go.drag.node._handleEvent("dragmove",evt),node.lastDragTime=(new Date).getTime()}}},_buildDOM:function(){this.content=document.createElement("div"),this.content.style.position="relative",this.content.style.display="inline-block",this.content.className="kineticjs-content",this.attrs.container.appendChild(this.content),this.bufferCanvas=new Kinetic.Canvas({width:this.attrs.width,height:this.attrs.height}),this.pathCanvas=new Kinetic.Canvas({width:this.attrs.width,height:this.attrs.height}),this.pathCanvas.strip(),this._resizeDOM()},_addId:function(node){node.attrs.id!==undefined&&(this.ids[node.attrs.id]=node)},_removeId:function(id){id!==undefined&&delete this.ids[id]},_addName:function(node){var name=node.attrs.name;name!==undefined&&(this.names[name]===undefined&&(this.names[name]=[]),this.names[name].push(node))},_removeName:function(name,_id){if(name!==undefined){var nodes=this.names[name];if(nodes!==undefined){for(var n=0;n<nodes.length;n++){var no=nodes[n];no._id===_id&&nodes.splice(n,1)}nodes.length===0&&delete this.names[name]}}},_onContent:function(typesStr,handler){var types=typesStr.split(" ");for(var n=0;n<types.length;n++){var baseEvent=types[n];this.content.addEventListener(baseEvent,handler,!1)}},_setStageDefaultProperties:function(){this.nodeType="Stage",this.dblClickWindow=400,this.targetShape=undefined,this.targetFound=!1,this.mouseoverShape=undefined,this.mouseoutShape=undefined,this.mousePos=undefined,this.mouseDown=!1,this.mouseUp=!1,this.mouseMove=!1,this.clickStart=!1,this.touchPos=undefined,this.touchStart=!1,this.touchEnd=!1,this.touchMove=!1,this.tapStart=!1,this.ids={},this.names={},this.anim=new Kinetic.Animation,this.animRunning=!1},_draw:function(canvas){this._drawChildren(canvas)}}),Kinetic.Node.addGettersSetters(Kinetic.Stage,["width","height"]),Kinetic.Layer=Kinetic.Container.extend({init:function(config){this.setDefaultAttrs({clearBeforeDraw:!0}),this.nodeType="Layer",this.lastDrawTime=0,this.beforeDrawFunc=undefined,this.afterDrawFunc=undefined,this.canvas=new Kinetic.Canvas,this.canvas.getElement().style.position="absolute",this._super(config)},draw:function(canvas){this._draw(canvas)},beforeDraw:function(func){this.beforeDrawFunc=func},afterDraw:function(func){this.afterDrawFunc=func},getCanvas:function(){return this.canvas},getContext:function(){return this.canvas.context},clear:function(){this.getCanvas().clear()},toDataURL:function(config){var canvas,mimeType=config&&config.mimeType?config.mimeType:null,quality=config&&config.quality?config.quality:null;return config&&config.width&&config.height?canvas=new Kinetic.Canvas(config.width,config.height):canvas=this.getCanvas(),canvas.toDataURL(mimeType,quality)},_draw:function(canvas){canvas||(canvas=this.getCanvas());var time=(new Date).getTime();this.lastDrawTime=time,this.beforeDrawFunc!==undefined&&this.beforeDrawFunc.call(this),this.attrs.clearBeforeDraw&&canvas.clear(),this.isVisible()&&(this.attrs.drawFunc!==undefined&&this.attrs.drawFunc.call(this),this._drawChildren(canvas)),this.afterDrawFunc!==undefined&&this.afterDrawFunc.call(this)}}),Kinetic.Node.addGettersSetters(Kinetic.Layer,["clearBeforeDraw"]),Kinetic.Group=Kinetic.Container.extend({init:function(config){this.nodeType="Group",this._super(config)},draw:function(canvas){this._draw(canvas)},_draw:function(canvas){this.attrs.visible&&this._drawChildren(canvas)}}),Kinetic.Shape=Kinetic.Node.extend({init:function(config){this.setDefaultAttrs({detectionType:"path"}),this.nodeType="Shape",this.appliedShadow=!1,this._super(config)},getContext:function(){return this.getLayer().getContext()},getCanvas:function(){return this.getLayer().getCanvas()},stroke:function(context){var strokeWidth=this.getStrokeWidth(),stroke=this.getStroke();if(stroke||strokeWidth){var go=Kinetic.Global,appliedShadow=!1;context.save(),this.attrs.shadow&&!this.appliedShadow&&(appliedShadow=this._applyShadow(context)),context.lineWidth=strokeWidth||2,context.strokeStyle=stroke||"black",context.stroke(context),context.restore(),appliedShadow&&this.stroke(context)}},fill:function(context){var appliedShadow=!1,fill=this.attrs.fill;if(fill){context.save(),this.attrs.shadow&&!this.appliedShadow&&(appliedShadow=this._applyShadow(context));var s=fill.start,e=fill.end,f=null;if(Kinetic.Type._isString(fill))context.fillStyle=fill,context.fill(context);else if(fill.image){var repeat=fill.repeat?fill.repeat:"repeat";fill.scale&&context.scale(fill.scale.x,fill.scale.y),fill.offset&&context.translate(fill.offset.x,fill.offset.y),context.fillStyle=context.createPattern(fill.image,repeat),context.fill(context)}else if(!s.radius&&!e.radius){var grd=context.createLinearGradient(s.x,s.y,e.x,e.y),colorStops=fill.colorStops;for(var n=0;n<colorStops.length;n+=2)grd.addColorStop(colorStops[n],colorStops[n+1]);context.fillStyle=grd,context.fill(context)}else if(!s.radius&&s.radius!==0||!e.radius&&e.radius!==0)context.fillStyle="black",context.fill(context);else{var grd=context.createRadialGradient(s.x,s.y,s.radius,e.x,e.y,e.radius),colorStops=fill.colorStops;for(var n=0;n<colorStops.length;n+=2)grd.addColorStop(colorStops[n],colorStops[n+1]);context.fillStyle=grd,context.fill(context)}context.restore()}appliedShadow&&this.fill(context)},fillText:function(context,text){var appliedShadow=!1;this.attrs.textFill&&(context.save(),this.attrs.shadow&&!this.appliedShadow&&(appliedShadow=this._applyShadow(context)),context.fillStyle=this.attrs.textFill,context.fillText(text,0,0),context.restore()),appliedShadow&&this.fillText(context,text,0,0)},strokeText:function(context,text){var appliedShadow=!1;if(this.attrs.textStroke||this.attrs.textStrokeWidth){context.save(),this.attrs.shadow&&!this.appliedShadow&&(appliedShadow=this._applyShadow(context));var textStroke=this.attrs.textStroke?this.attrs.textStroke:"black",textStrokeWidth=this.attrs.textStrokeWidth?this.attrs.textStrokeWidth:2;context.lineWidth=textStrokeWidth,context.strokeStyle=textStroke,context.strokeText(text,0,0),context.restore()}appliedShadow&&this.strokeText(context,text,0,0)},drawImage:function(){var appliedShadow=!1,context=arguments[0];context.save();var a=Array.prototype.slice.call(arguments);if(a.length===6||a.length===10)this.attrs.shadow&&!this.appliedShadow&&(appliedShadow=this._applyShadow(context)),a.length===6?context.drawImage(a[1],a[2],a[3],a[4],a[5]):context.drawImage(a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9]);context.restore(),appliedShadow&&this.drawImage.apply(this,a)},applyLineJoin:function(context){this.attrs.lineJoin&&(context.lineJoin=this.attrs.lineJoin)},_applyShadow:function(context){var s=this.attrs.shadow;if(s){var aa=this.getAbsoluteAlpha(),color=s.color?s.color:"black",blur=s.blur?s.blur:5,offset=s.offset?s.offset:{x:0,y:0};return s.alpha&&(context.globalAlpha=s.alpha*aa),context.shadowColor=color,context.shadowBlur=blur,context.shadowOffsetX=offset.x,context.shadowOffsetY=offset.y,this.appliedShadow=!0,!0}return!1},intersects:function(){var pos=Kinetic.Type._getXY(Array.prototype.slice.call(arguments)),stage=this.getStage();if(this.attrs.detectionType==="path"){var pathCanvas=stage.pathCanvas,pathCanvasContext=pathCanvas.getContext();return this._draw(pathCanvas),pathCanvasContext.isPointInPath(pos.x,pos.y)}if(this.imageData){var w=stage.attrs.width,alpha=this.imageData.data[(w*pos.y+pos.x)*4+3];return alpha}return!1},_draw:function(canvas){if(this.attrs.drawFunc){var stage=this.getStage(),context=canvas.getContext(),family=[],parent=this.parent;family.unshift(this);while(parent)family.unshift(parent),parent=parent.parent;context.save();for(var n=0;n<family.length;n++){var node=family[n],t=node.getTransform(),m=t.getMatrix();context.transform(m[0],m[1],m[2],m[3],m[4],m[5])}var absAlpha=this.getAbsoluteAlpha();absAlpha!==1&&(context.globalAlpha=absAlpha),this.applyLineJoin(context),this.appliedShadow=!1,this.attrs.drawFunc.call(this,canvas.getContext()),context.restore()}}}),Kinetic.Node.addGettersSetters(Kinetic.Shape,["fill","stroke","lineJoin","strokeWidth","shadow","drawFunc","filter"]),Kinetic.Rect=Kinetic.Shape.extend({init:function(config){this.setDefaultAttrs({width:0,height:0,cornerRadius:0}),this.shapeType="Rect",config.drawFunc=this.drawFunc,this._super(config)},drawFunc:function(context){context.beginPath(),this.attrs.cornerRadius===0?context.rect(0,0,this.attrs.width,this.attrs.height):(context.moveTo(this.attrs.cornerRadius,0),context.lineTo(this.attrs.width-this.attrs.cornerRadius,0),context.arc(this.attrs.width-this.attrs.cornerRadius,this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI*3/2,0,!1),context.lineTo(this.attrs.width,this.attrs.height-this.attrs.cornerRadius),context.arc(this.attrs.width-this.attrs.cornerRadius,this.attrs.height-this.attrs.cornerRadius,this.attrs.cornerRadius,0,Math.PI/2,!1),context.lineTo(this.attrs.cornerRadius,this.attrs.height),context.arc(this.attrs.cornerRadius,this.attrs.height-this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI/2,Math.PI,!1),context.lineTo(0,this.attrs.cornerRadius),context.arc(this.attrs.cornerRadius,this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI,Math.PI*3/2,!1)),context.closePath(),this.fill(context),this.stroke(context)},setSize:function(){var size=Kinetic.Type._getSize(Array.prototype.slice.call(arguments));this.setAttrs(size)},getSize:function(){return{width:this.attrs.width,height:this.attrs.height}}}),Kinetic.Node.addGettersSetters(Kinetic.Rect,["width","height","cornerRadius"]),Kinetic.Ellipse=Kinetic.Shape.extend({init:function(config){this.setDefaultAttrs({radius:{x:0,y:0}}),this.shapeType="Ellipse",config.drawFunc=this.drawFunc,this._super(config),this._convertRadius();var that=this;this.on("radiusChange.kinetic",function(){that._convertRadius()})},drawFunc:function(context){var r=this.getRadius();context.beginPath(),context.save(),r.x!==r.y&&context.scale(1,r.y/r.x),context.arc(0,0,r.x,0,Math.PI*2,!0),context.restore(),context.closePath(),this.fill(context),this.stroke(context)},_convertRadius:function(){var type=Kinetic.Type,radius=this.getRadius();if(type._isObject(radius))return!1;this.attrs.radius=type._getXY(radius)}}),Kinetic.Circle=Kinetic.Ellipse,Kinetic.Node.addGettersSetters(Kinetic.Ellipse,["radius"]),Kinetic.Image=Kinetic.Shape.extend({init:function(config){this.shapeType="Image",config.drawFunc=this.drawFunc,this._super(config)},drawFunc:function(context){if(this.attrs.image){var width=this.getWidth(),height=this.getHeight();context.beginPath(),context.rect(0,0,width,height),context.closePath(),this.fill(context),this.stroke(context);if(this.attrs.crop&&this.attrs.crop.width&&this.attrs.crop.height){var cropX=this.attrs.crop.x?this.attrs.crop.x:0,cropY=this.attrs.crop.y?this.attrs.crop.y:0,cropWidth=this.attrs.crop.width,cropHeight=this.attrs.crop.height;this.drawImage(context,this.attrs.image,cropX,cropY,cropWidth,cropHeight,0,0,width,height)}else this.drawImage(context,this.attrs.image,0,0,width,height)}},setSize:function(){var size=Kinetic.Type._getSize(Array.prototype.slice.call(arguments));this.setAttrs(size)},getSize:function(){return{width:this.attrs.width,height:this.attrs.height}},getWidth:function(){return this.attrs.width?this.attrs.width:this.attrs.image?this.attrs.image.width:0},getHeight:function(){return this.attrs.height?this.attrs.height:this.attrs.image?this.attrs.image.height:0},applyFilter:function(config){try{var trans=this._clearTransform();this.saveImageData(this.getWidth(),this.getHeight()),this._setTransform(trans),config.filter.call(this,config);var that=this;Kinetic.Type._getImage(this.getImageData(),function(imageObj){that.setImage(imageObj),config.callback&&config.callback()})}catch(e){Kinetic.Global.warn("Unable to apply filter.")}}}),Kinetic.Node.addGettersSetters(Kinetic.Image,["image","crop","filter"]),Kinetic.Node.addSetters(Kinetic.Image,["width","height"]),Kinetic.Polygon=Kinetic.Shape.extend({init:function(config){this.setDefaultAttrs({points:[]}),this.shapeType="Polygon",config.drawFunc=this.drawFunc,this._super(config)},drawFunc:function(context){context.beginPath(),context.moveTo(this.attrs.points[0].x,this.attrs.points[0].y);for(var n=1;n<this.attrs.points.length;n++)context.lineTo(this.attrs.points[n].x,this.attrs.points[n].y);context.closePath(),this.fill(context),this.stroke(context)}}),Kinetic.Node.addGettersSetters(Kinetic.Polygon,["points"]),Kinetic.Text=Kinetic.Shape.extend({init:function(config){this.setDefaultAttrs({fontFamily:"Calibri",text:"",fontSize:12,align:"left",verticalAlign:"top",fontStyle:"normal",padding:0,width:"auto",height:"auto",detectionType:"path",cornerRadius:0,lineHeight:1.2}),this.dummyCanvas=document.createElement("canvas"),this.shapeType="Text",config.drawFunc=this.drawFunc,this._super(config);var attrs=["fontFamily","fontSize","fontStyle","padding","align","lineHeight","text","width","height"],that=this;for(var n=0;n<attrs.length;n++){var attr=attrs[n];this.on(attr+"Change.kinetic",that._setTextData)}that._setTextData()},drawFunc:function(context){context.beginPath();var boxWidth=this.getBoxWidth(),boxHeight=this.getBoxHeight();this.attrs.cornerRadius===0?context.rect(0,0,boxWidth,boxHeight):(context.moveTo(this.attrs.cornerRadius,0),context.lineTo(boxWidth-this.attrs.cornerRadius,0),context.arc(boxWidth-this.attrs.cornerRadius,this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI*3/2,0,!1),context.lineTo(boxWidth,boxHeight-this.attrs.cornerRadius),context.arc(boxWidth-this.attrs.cornerRadius,boxHeight-this.attrs.cornerRadius,this.attrs.cornerRadius,0,Math.PI/2,!1),context.lineTo(this.attrs.cornerRadius,boxHeight),context.arc(this.attrs.cornerRadius,boxHeight-this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI/2,Math.PI,!1),context.lineTo(0,this.attrs.cornerRadius),context.arc(this.attrs.cornerRadius,this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI,Math.PI*3/2,!1)),context.closePath(),this.fill(context),this.stroke(context);var p=this.attrs.padding,lineHeightPx=this.attrs.lineHeight*this.getTextHeight(),textArr=this.textArr;context.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"pt "+this.attrs.fontFamily,context.textBaseline="middle",context.textAlign="left",context.save(),context.translate(p,0),context.translate(0,p+this.getTextHeight()/2);for(var n=0;n<textArr.length;n++){var text=textArr[n];context.save(),this.attrs.align==="right"?context.translate(this.getBoxWidth()-this._getTextSize(text).width-p*2,0):this.attrs.align==="center"&&context.translate((this.getBoxWidth()-this._getTextSize(text).width-p*2)/2,0),this.fillText(context,text),this.strokeText(context,text),context.restore(),context.translate(0,lineHeightPx)}context.restore()},getBoxWidth:function(){return this.attrs.width==="auto"?this.getTextWidth()+this.attrs.padding*2:this.attrs.width},getBoxHeight:function(){return this.attrs.height==="auto"?this.getTextHeight()*this.textArr.length*this.attrs.lineHeight+this.attrs.padding*2:this.attrs.height},getTextWidth:function(){return this.textWidth},getTextHeight:function(){return this.textHeight},_getTextSize:function(text){var dummyCanvas=this.dummyCanvas,context=dummyCanvas.getContext("2d");context.save(),context.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"pt "+this.attrs.fontFamily;var metrics=context.measureText(text);return context.restore(),{width:metrics.width,height:parseInt(this.attrs.fontSize,10)}},_setTextData:function(){var charArr=this.attrs.text.split(""),arr=[],row=0,addLine=!0;this.textWidth=0,this.textHeight=this._getTextSize(this.attrs.text).height;var lineHeightPx=this.attrs.lineHeight*this.textHeight;while(charArr.length>0&&addLine&&(this.attrs.height==="auto"||lineHeightPx*(row+1)<this.attrs.height-this.attrs.padding*2)){var index=0,line=undefined;addLine=!1;while(index<charArr.length){if(charArr.indexOf("\n")===index){charArr.splice(index,1),line=charArr.splice(0,index).join("");break}var lineArr=charArr.slice(0,index);if(this.attrs.width!=="auto"&&this._getTextSize(lineArr.join("")).width>this.attrs.width-this.attrs.padding*2){if(index==0)break;var lastSpace=lineArr.lastIndexOf(" "),lastDash=lineArr.lastIndexOf("-"),wrapIndex=Math.max(lastSpace,lastDash);if(wrapIndex>=0){line=charArr.splice(0,1+wrapIndex).join("");break}line=charArr.splice(0,index).join("");break}index++,index===charArr.length&&(line=charArr.splice(0,index).join(""))}this.textWidth=Math.max(this.textWidth,this._getTextSize(line).width),line!==undefined&&(arr.push(line),addLine=!0),row++}this.textArr=arr}}),Kinetic.Node.addGettersSetters(Kinetic.Text,["fontFamily","fontSize","fontStyle","textFill","textStroke","textStrokeWidth","padding","align","lineHeight","text","width","height","cornerRadius","fill","stroke","strokeWidth","shadow"]),Kinetic.Line=Kinetic.Shape.extend({init:function(config){this.setDefaultAttrs({points:[],lineCap:"butt",dashArray:[],detectionType:"pixel"}),this.shapeType="Line",config.drawFunc=this.drawFunc,this._super(config)},drawFunc:function(context){var lastPos={};context.beginPath(),context.moveTo(this.attrs.points[0].x,this.attrs.points[0].y);for(var n=1;n<this.attrs.points.length;n++){var x=this.attrs.points[n].x,y=this.attrs.points[n].y;if(this.attrs.dashArray.length>0){var lastX=this.attrs.points[n-1].x,lastY=this.attrs.points[n-1].y;this._dashedLine(context,lastX,lastY,x,y,this.attrs.dashArray)}else context.lineTo(x,y)}!this.attrs.lineCap||(context.lineCap=this.attrs.lineCap),this.stroke(context)},_dashedLine:function(context,x,y,x2,y2,dashArray){var dashCount=dashArray.length,dx=x2-x,dy=y2-y,xSlope=dx>dy,slope=xSlope?dy/dx:dx/dy;slope>9999?slope=9999:slope<-9999&&(slope=-9999);var distRemaining=Math.sqrt(dx*dx+dy*dy),dashIndex=0,draw=!0;while(distRemaining>=.1&&dashIndex<1e4){var dashLength=dashArray[dashIndex++%dashCount];dashLength===0&&(dashLength=.001),dashLength>distRemaining&&(dashLength=distRemaining);var step=Math.sqrt(dashLength*dashLength/(1+slope*slope));xSlope?(x+=dx<0&&dy<0?step*-1:step,y+=dx<0&&dy<0?slope*step*-1:slope*step):(x+=dx<0&&dy<0?slope*step*-1:slope*step,y+=dx<0&&dy<0?step*-1:step),context[draw?"lineTo":"moveTo"](x,y),distRemaining-=dashLength,draw=!draw}context.moveTo(x2,y2)}}),Kinetic.Node.addGettersSetters(Kinetic.Line,["dashArray","lineCap","points"]),Kinetic.Sprite=Kinetic.Shape.extend({init:function(config){this.setDefaultAttrs({index:0,frameRate:17}),config.drawFunc=this.drawFunc,this._super(config),this.anim=new Kinetic.Animation;var that=this;this.on("animationChange.kinetic",function(){that.setIndex(0)})},drawFunc:function(context){if(this.attrs.image){var anim=this.attrs.animation,index=this.attrs.index,f=this.attrs.animations[anim][index];context.beginPath(),context.rect(0,0,f.width,f.height),context.closePath(),this.drawImage(context,this.attrs.image,f.x,f.y,f.width,f.height,0,0,f.width,f.height)}},start:function(){var that=this,layer=this.getLayer(),ka=Kinetic.Animation;ka._removeAnimation(this.anim),this.anim.node=layer,ka._addAnimation(this.anim),this.interval=setInterval(function(){var index=that.attrs.index;that._updateIndex(),that.afterFrameFunc&&index===that.afterFrameIndex&&that.afterFrameFunc()},1e3/this.attrs.frameRate),ka._handleAnimation()},stop:function(){Kinetic.Animation._removeAnimation(this.anim),clearInterval(this.interval)},afterFrame:function(index,func){this.afterFrameIndex=index,this.afterFrameFunc=func},_updateIndex:function(){var i=this.attrs.index,a=this.attrs.animation;i<this.attrs.animations[a].length-1?this.attrs.index++:this.attrs.index=0}}),Kinetic.Node.addGettersSetters(Kinetic.Sprite,["animation","animations","index"]),Kinetic.Star=Kinetic.Shape.extend({init:function(config){this.setDefaultAttrs({numPoints:0,innerRadius:0,outerRadius:0}),this.shapeType="Star",config.drawFunc=this.drawFunc,this._super(config)},drawFunc:function(context){context.beginPath(),context.moveTo(0,0-this.attrs.outerRadius);for(var n=1;n<this.attrs.numPoints*2;n++){var radius=n%2===0?this.attrs.outerRadius:this.attrs.innerRadius,x=radius*Math.sin(n*Math.PI/this.attrs.numPoints),y=-1*radius*Math.cos(n*Math.PI/this.attrs.numPoints);context.lineTo(x,y)}context.closePath(),this.fill(context),this.stroke(context)}}),Kinetic.Node.addGettersSetters(Kinetic.Star,["numPoints","innerRadius","outerRadius"]),Kinetic.RegularPolygon=Kinetic.Shape.extend({init:function(config){this.setDefaultAttrs({radius:0,sides:0}),this.shapeType="RegularPolygon",config.drawFunc=this.drawFunc,this._super(config)},drawFunc:function(context){context.beginPath(),context.moveTo(0,0-this.attrs.radius);for(var n=1;n<this.attrs.sides;n++){var x=this.attrs.radius*Math.sin(n*2*Math.PI/this.attrs.sides),y=-1*this.attrs.radius*Math.cos(n*2*Math.PI/this.attrs.sides);context.lineTo(x,y)}context.closePath(),this.fill(context),this.stroke(context)}}),Kinetic.Node.addGettersSetters(Kinetic.RegularPolygon,["radius","sides"]),Kinetic.Path=Kinetic.Shape.extend({init:function(config){this.shapeType="Path",this.dataArray=[];var that=this;config.drawFunc=this.drawFunc,this._super(config),this.dataArray=Kinetic.Path.parsePathData(this.attrs.data),this.on("dataChange",function(){that.dataArray=Kinetic.Path.parsePathData(that.attrs.data)})},drawFunc:function(context){var ca=this.dataArray;context.beginPath();for(var n=0;n<ca.length;n++){var c=ca[n].command,p=ca[n].points;switch(c){case"L":context.lineTo(p[0],p[1]);break;case"M":context.moveTo(p[0],p[1]);break;case"C":context.bezierCurveTo(p[0],p[1],p[2],p[3],p[4],p[5]);break;case"Q":context.quadraticCurveTo(p[0],p[1],p[2],p[3]);break;case"A":var cx=p[0],cy=p[1],rx=p[2],ry=p[3],theta=p[4],dTheta=p[5],psi=p[6],fs=p[7],r=rx>ry?rx:ry,scaleX=rx>ry?1:rx/ry,scaleY=rx>ry?ry/rx:1;context.translate(cx,cy),context.rotate(psi),context.scale(scaleX,scaleY),context.arc(0,0,r,theta,theta+dTheta,1-fs),context.scale(1/scaleX,1/scaleY),context.rotate(-psi),context.translate(-cx,-cy);break;case"z":context.closePath()}}this.fill(context),this.stroke(context)}}),Kinetic.Path.getLineLength=function(x1,y1,x2,y2){return Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1))},Kinetic.Path.getPointOnLine=function(dist,P1x,P1y,P2x,P2y,fromX,fromY){fromX===undefined&&(fromX=P1x),fromY===undefined&&(fromY=P1y);var m=(P2y-P1y)/(P2x-P1x+1e-8),run=Math.sqrt(dist*dist/(1+m*m)),rise=m*run,pt;if((fromY-P1y)/(fromX-P1x+1e-8)===m)pt={x:fromX+run,y:fromY+rise};else{var ix,iy,len=this.getLineLength(P1x,P1y,P2x,P2y);if(len<1e-8)return undefined;var u=(fromX-P1x)*(P2x-P1x)+(fromY-P1y)*(P2y-P1y);u/=len*len,ix=P1x+u*(P2x-P1x),iy=P1y+u*(P2y-P1y);var pRise=this.getLineLength(fromX,fromY,ix,iy),pRun=Math.sqrt(dist*dist-pRise*pRise);run=Math.sqrt(pRun*pRun/(1+m*m)),rise=m*run,pt={x:ix+run,y:iy+rise}}return pt},Kinetic.Path.getPointOnCubicBezier=function(pct,P1x,P1y,P2x,P2y,P3x,P3y,P4x,P4y){function CB1(t){return t*t*t}function CB2(t){return 3*t*t*(1-t)}function CB3(t){return 3*t*(1-t)*(1-t)}function CB4(t){return(1-t)*(1-t)*(1-t)}var x=P4x*CB1(pct)+P3x*CB2(pct)+P2x*CB3(pct)+P1x*CB4(pct),y=P4y*CB1(pct)+P3y*CB2(pct)+P2y*CB3(pct)+P1y*CB4(pct);return{x:x,y:y}},Kinetic.Path.getPointOnQuadraticBezier=function(pct,P1x,P1y,P2x,P2y,P3x,P3y){function QB1(t){return t*t}function QB2(t){return 2*t*(1-t)}function QB3(t){return(1-t)*(1-t)}var x=P3x*QB1(pct)+P2x*QB2(pct)+P1x*QB3(pct),y=P3y*QB1(pct)+P2y*QB2(pct)+P1y*QB3(pct);return{x:x,y:y}},Kinetic.Path.getPointOnEllipticalArc=function(cx,cy,rx,ry,theta,psi){var cosPsi=Math.cos(psi),sinPsi=Math.sin(psi),pt={x:rx*Math.cos(theta),y:ry*Math.sin(theta)};return{x:cx+(pt.x*cosPsi-pt.y*sinPsi),y:cy+(pt.x*sinPsi+pt.y*cosPsi)}},Kinetic.Path.parsePathData=function(data){if(!data)return[];var cs=data,cc=["m","M","l","L","v","V","h","H","z","Z","c","C","q","Q","t","T","s","S","a","A"];cs=cs.replace(new RegExp(" ","g"),",");for(var n=0;n<cc.length;n++)cs=cs.replace(new RegExp(cc[n],"g"),"|"+cc[n]);var arr=cs.split("|"),ca=[],cpx=0,cpy=0;for(var n=1;n<arr.length;n++){var str=arr[n],c=str.charAt(0);str=str.slice(1),str=str.replace(new RegExp(",-","g"),"-"),str=str.replace(new RegExp("-","g"),",-"),str=str.replace(new RegExp("e,-","g"),"e-");var p=str.split(",");p.length>0&&p[0]===""&&p.shift();for(var i=0;i<p.length;i++)p[i]=parseFloat(p[i]);while(p.length>0){if(isNaN(p[0]))break;var cmd=null,points=[],startX=cpx,startY=cpy;switch(c){case"l":cpx+=p.shift(),cpy+=p.shift(),cmd="L",points.push(cpx,cpy);break;case"L":cpx=p.shift(),cpy=p.shift(),points.push(cpx,cpy);break;case"m":cpx+=p.shift(),cpy+=p.shift(),cmd="M",points.push(cpx,cpy),c="l";break;case"M":cpx=p.shift(),cpy=p.shift(),cmd="M",points.push(cpx,cpy),c="L";break;case"h":cpx+=p.shift(),cmd="L",points.push(cpx,cpy);break;case"H":cpx=p.shift(),cmd="L",points.push(cpx,cpy);break;case"v":cpy+=p.shift(),cmd="L",points.push(cpx,cpy);break;case"V":cpy=p.shift(),cmd="L",points.push(cpx,cpy);break;case"C":points.push(p.shift(),p.shift(),p.shift(),p.shift()),cpx=p.shift(),cpy=p.shift(),points.push(cpx,cpy);break;case"c":points.push(cpx+p.shift(),cpy+p.shift(),cpx+p.shift(),cpy+p.shift()),cpx+=p.shift(),cpy+=p.shift(),cmd="C",points.push(cpx,cpy);break;case"S":var ctlPtx=cpx,ctlPty=cpy,prevCmd=ca[ca.length-1];prevCmd.command==="C"&&(ctlPtx=cpx+(cpx-prevCmd.points[2]),ctlPty=cpy+(cpy-prevCmd.points[3])),points.push(ctlPtx,ctlPty,p.shift(),p.shift()),cpx=p.shift(),cpy=p.shift(),cmd="C",points.push(cpx,cpy);break;case"s":var ctlPtx=cpx,ctlPty=cpy,prevCmd=ca[ca.length-1];prevCmd.command==="C"&&(ctlPtx=cpx+(cpx-prevCmd.points[2]),ctlPty=cpy+(cpy-prevCmd.points[3])),points.push(ctlPtx,ctlPty,cpx+p.shift(),cpy+p.shift()),cpx+=p.shift(),cpy+=p.shift(),cmd="C",points.push(cpx,cpy);break;case"Q":points.push(p.shift(),p.shift()),cpx=p.shift(),cpy=p.shift(),points.push(cpx,cpy);break;case"q":points.push(cpx+p.shift(),cpy+p.shift()),cpx+=p.shift(),cpy+=p.shift(),cmd="Q",points.push(cpx,cpy);break;case"T":var ctlPtx=cpx,ctlPty=cpy,prevCmd=ca[ca.length-1];prevCmd.command==="Q"&&(ctlPtx=cpx+(cpx-prevCmd.points[0]),ctlPty=cpy+(cpy-prevCmd.points[1])),cpx=p.shift(),cpy=p.shift(),cmd="Q",points.push(ctlPtx,ctlPty,cpx,cpy);break;case"t":var ctlPtx=cpx,ctlPty=cpy,prevCmd=ca[ca.length-1];prevCmd.command==="Q"&&(ctlPtx=cpx+(cpx-prevCmd.points[0]),ctlPty=cpy+(cpy-prevCmd.points[1])),cpx+=p.shift(),cpy+=p.shift(),cmd="Q",points.push(ctlPtx,ctlPty,cpx,cpy);break;case"A":var rx=p.shift(),ry=p.shift(),psi=p.shift(),fa=p.shift(),fs=p.shift(),x1=cpx,y1=cpy;cpx=p.shift(),cpy=p.shift(),cmd="A",points=this.convertEndpointToCenterParameterization(x1,y1,cpx,cpy,fa,fs,rx,ry,psi);break;case"a":var rx=p.shift(),ry=p.shift(),psi=p.shift(),fa=p.shift(),fs=p.shift(),x1=cpx,y1=cpy;cpx+=p.shift(),cpy+=p.shift(),cmd="A",points=this.convertEndpointToCenterParameterization(x1,y1,cpx,cpy,fa,fs,rx,ry,psi)}ca.push({command:cmd||c,points:points,start:{x:startX,y:startY},pathLength:this.calcLength(startX,startY,cmd||c,points)})}(c==="z"||c==="Z")&&ca.push({command:"z",points:[],start:undefined,pathLength:0})}return ca},Kinetic.Path.calcLength=function(x,y,cmd,points){var len,p1,p2,path=Kinetic.Path;switch(cmd){case"L":return path.getLineLength(x,y,points[0],points[1]);case"C":len=0,p1=path.getPointOnCubicBezier(0,x,y,points[0],points[1],points[2],points[3],points[4],points[5]);for(t=.01;t<=1;t+=.01)p2=path.getPointOnCubicBezier(t,x,y,points[0],points[1],points[2],points[3],points[4],points[5]),len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y),p1=p2;return len;case"Q":len=0,p1=path.getPointOnQuadraticBezier(0,x,y,points[0],points[1],points[2],points[3]);for(t=.01;t<=1;t+=.01)p2=path.getPointOnQuadraticBezier(t,x,y,points[0],points[1],points[2],points[3]),len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y),p1=p2;return len;case"A":len=0;var start=points[4],dTheta=points[5],end=points[4]+dTheta,inc=Math.PI/180;Math.abs(start-end)<inc&&(inc=Math.abs(start-end)),p1=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],start,0);if(dTheta<0)for(t=start-inc;t>end;t-=inc)p2=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],t,0),len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y),p1=p2;else for(t=start+inc;t<end;t+=inc)p2=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],t,0),len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y),p1=p2;return p2=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],end,0),len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y),len}return 0},Kinetic.Path.convertEndpointToCenterParameterization=function(x1,y1,x2,y2,fa,fs,rx,ry,psiDeg){var psi=psiDeg*(Math.PI/180),xp=Math.cos(psi)*(x1-x2)/2+Math.sin(psi)*(y1-y2)/2,yp=-1*Math.sin(psi)*(x1-x2)/2+Math.cos(psi)*(y1-y2)/2,lambda=xp*xp/(rx*rx)+yp*yp/(ry*ry);lambda>1&&(rx*=Math.sqrt(lambda),ry*=Math.sqrt(lambda));var f=Math.sqrt((rx*rx*ry*ry-rx*rx*yp*yp-ry*ry*xp*xp)/(rx*rx*yp*yp+ry*ry*xp*xp));fa==fs&&(f*=-1),isNaN(f)&&(f=0);var cxp=f*rx*yp/ry,cyp=f*-ry*xp/rx,cx=(x1+x2)/2+Math.cos(psi)*cxp-Math.sin(psi)*cyp,cy=(y1+y2)/2+Math.sin(psi)*cxp+Math.cos(psi)*cyp,vMag=function(v){return Math.sqrt(v[0]*v[0]+v[1]*v[1])},vRatio=function(u,v){return(u[0]*v[0]+u[1]*v[1])/(vMag(u)*vMag(v))},vAngle=function(u,v){return(u[0]*v[1]<u[1]*v[0]?-1:1)*Math.acos(vRatio(u,v))},theta=vAngle([1,0],[(xp-cxp)/rx,(yp-cyp)/ry]),u=[(xp-cxp)/rx,(yp-cyp)/ry],v=[(-1*xp-cxp)/rx,(-1*yp-cyp)/ry],dTheta=vAngle(u,v);return vRatio(u,v)<=-1&&(dTheta=Math.PI),vRatio(u,v)>=1&&(dTheta=0),fs===0&&dTheta>0&&(dTheta-=2*Math.PI),fs==1&&dTheta<0&&(dTheta+=2*Math.PI),[cx,cy,rx,ry,theta,dTheta,psi,fs]},Kinetic.Node.addGettersSetters(Kinetic.Path,["data"]),Kinetic.TextPath=Kinetic.Shape.extend({init:function(config){this.setDefaultAttrs({fontFamily:"Calibri",fontSize:12,fontStyle:"normal",detectionType:"path",text:""}),this.dummyCanvas=document.createElement("canvas"),this.shapeType="TextPath",this.dataArray=[];var that=this;config.drawFunc=this.drawFunc,this._super(config),this.dataArray=Kinetic.Path.parsePathData(this.attrs.data),this.on("dataChange",function(){that.dataArray=Kinetic.Path.parsePathData(this.attrs.data)});var attrs=["text","textStroke","textStrokeWidth"];for(var n=0;n<attrs.length;n++){var attr=attrs[n];this.on(attr+"Change",that._setTextData)}that._setTextData()},drawFunc:function(context){var charArr=this.charArr;context.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"pt "+this.attrs.fontFamily,context.textBaseline="middle",context.textAlign="left",context.save();var glyphInfo=this.glyphInfo;for(var i=0;i<glyphInfo.length;i++){context.save();var p0=glyphInfo[i].p0,p1=glyphInfo[i].p1,ht=parseFloat(this.attrs.fontSize);context.translate(p0.x,p0.y),context.rotate(glyphInfo[i].rotation),this.fillText(context,glyphInfo[i].text),this.strokeText(context,glyphInfo[i].text),context.restore()}context.restore()},getTextWidth:function(){return this.textWidth},getTextHeight:function(){return this.textHeight},_getTextSize:function(text){var dummyCanvas=this.dummyCanvas,context=dummyCanvas.getContext("2d");context.save(),context.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"pt "+this.attrs.fontFamily;var metrics=context.measureText(text);return context.restore(),{width:metrics.width,height:parseInt(this.attrs.fontSize,10)}},_setTextData:function(){var that=this,size=this._getTextSize(this.attrs.text);this.textWidth=size.width,this.textHeight=size.height,this.glyphInfo=[];var charArr=this.attrs.text.split(""),p0,p1,pathCmd,pIndex=-1,currentT=0,getNextPathSegment=function(){currentT=0;var pathData=that.dataArray;for(var i=pIndex+1;i<pathData.length;i++){if(pathData[i].pathLength>0)return pIndex=i,pathData[i];pathData[i].command=="M"&&(p0={x:pathData[i].points[0],y:pathData[i].points[1]})}return{}},findSegmentToFitCharacter=function(c,before){var glyphWidth=that._getTextSize(c).width,currLen=0,attempts=0,needNextSegment=!1;p1=undefined;while(Math.abs(glyphWidth-currLen)/glyphWidth>.01&&attempts<25){attempts++;var cumulativePathLength=currLen;while(pathCmd===undefined)pathCmd=getNextPathSegment(),pathCmd&&cumulativePathLength+pathCmd.pathLength<glyphWidth&&(cumulativePathLength+=pathCmd.pathLength,pathCmd=undefined);if(pathCmd==={}||p0===undefined)return undefined;var needNewSegment=!1;switch(pathCmd.command){case"L":Kinetic.Path.getLineLength(p0.x,p0.y,pathCmd.points[0],pathCmd.points[1])>glyphWidth?p1=Kinetic.Path.getPointOnLine(glyphWidth,p0.x,p0.y,pathCmd.points[0],pathCmd.points[1],p0.x,p0.y):pathCmd=undefined;break;case"A":var start=pathCmd.points[4],dTheta=pathCmd.points[5],end=pathCmd.points[4]+dTheta;currentT===0?currentT=start+1e-8:glyphWidth>currLen?currentT+=Math.PI/180*dTheta/Math.abs(dTheta):currentT-=Math.PI/360*dTheta/Math.abs(dTheta),Math.abs(currentT)>Math.abs(end)&&(currentT=end,needNewSegment=!0),p1=Kinetic.Path.getPointOnEllipticalArc(pathCmd.points[0],pathCmd.points[1],pathCmd.points[2],pathCmd.points[3],currentT,pathCmd.points[6]);break;case"C":currentT===0?glyphWidth>pathCmd.pathLength?currentT=1e-8:currentT=glyphWidth/pathCmd.pathLength:glyphWidth>currLen?currentT+=(glyphWidth-currLen)/pathCmd.pathLength:currentT-=(currLen-glyphWidth)/pathCmd.pathLength,currentT>1&&(currentT=1,needNewSegment=!0),p1=Kinetic.Path.getPointOnCubicBezier(currentT,pathCmd.start.x,pathCmd.start.y,pathCmd.points[0],pathCmd.points[1],pathCmd.points[2],pathCmd.points[3],pathCmd.points[4],pathCmd.points[5]);break;case"Q":currentT===0?currentT=glyphWidth/pathCmd.pathLength:glyphWidth>currLen?currentT+=(glyphWidth-currLen)/pathCmd.pathLength:currentT-=(currLen-glyphWidth)/pathCmd.pathLength,currentT>1&&(currentT=1,needNewSegment=!0),p1=Kinetic.Path.getPointOnQuadraticBezier(currentT,pathCmd.start.x,pathCmd.start.y,pathCmd.points[0],pathCmd.points[1],pathCmd.points[2],pathCmd.points[3])}p1!==undefined&&(currLen=Kinetic.Path.getLineLength(p0.x,p0.y,p1.x,p1.y)),needNewSegment&&(needNewSegment=!1,pathCmd=undefined)}};for(var i=0;i<charArr.length;i++){findSegmentToFitCharacter(charArr[i]);if(p0===undefined||p1===undefined)break;var width=Kinetic.Path.getLineLength(p0.x,p0.y,p1.x,p1.y),kern=0,midpoint=Kinetic.Path.getPointOnLine(kern+width/2,p0.x,p0.y,p1.x,p1.y),rotation=Math.atan2(p1.y-p0.y,p1.x-p0.x);this.glyphInfo.push({transposeX:midpoint.x,transposeY:midpoint.y,text:charArr[i],rotation:rotation,p0:p0,p1:p1}),p0=p1}}}),Kinetic.Node.addGettersSetters(Kinetic.TextPath,["fontFamily","fontSize","fontStyle","textFill","textStroke","textStrokeWidth","text"]),define("libs/kinetic",function(global){return function(){return global.Kinetic}}(this)),define("util/domready",[],function(){function runCallbacks(callbacks){var i;for(i=0;i<callbacks.length;i+=1)callbacks[i](doc)}function callReady(){var callbacks=readyCalls;isPageLoaded&&callbacks.length&&(readyCalls=[],runCallbacks(callbacks))}function pageLoaded(){isPageLoaded||(isPageLoaded=!0,scrollIntervalId&&clearInterval(scrollIntervalId),callReady())}function domReady(callback){return isPageLoaded?callback(doc):readyCalls.push(callback),domReady}var isTop,testDiv,scrollIntervalId,isBrowser=typeof window!="undefined"&&window.document,isPageLoaded=!isBrowser,doc=isBrowser?document:null,readyCalls=[];if(isBrowser){if(document.addEventListener)document.addEventListener("DOMContentLoaded",pageLoaded,!1),window.addEventListener("load",pageLoaded,!1);else if(window.attachEvent){window.attachEvent("onload",pageLoaded),testDiv=document.createElement("div");try{isTop=window.frameElement===null}catch(e){}testDiv.doScroll&&isTop&&window.external&&(scrollIntervalId=setInterval(function(){try{testDiv.doScroll(),pageLoaded()}catch(e){}},30))}document.readyState==="complete"&&pageLoaded()}return domReady.version="2.0.1",domReady.load=function(name,req,onLoad,config){config.isBuild?onLoad(null):domReady(onLoad)},domReady}),define("mediators/plinko",["pquery","kinetic","util/domready"],function(pQuery,Kinetic,domready){return pQuery=pQuery.sub(),pQuery.fn.extend({updateView:function(){var vel=pQuery.Vector(),ref=pQuery.Vector(1,0);return this.each(function(){var obj=pQuery(".player"),img=obj.data("view"),pos,ang;if(obj.attr("fixed")||!img)return;pos=obj.position(),vel.clone(obj.velocity()).normalize(),ang=(vel.y>0?1:-1)*Math.acos(vel.dot(ref)),img.setX(pos.x),img.setY(pos.y),img.setRotation(ang)})}}),{bounds:{width:900,height:500},groups:{},globalAccel:{x:2e-4,y:0},init:function(){var self=this;domready(function(){self.stage=new Kinetic.Stage({container:"canvas-wrap",width:self.bounds.width,height:self.bounds.height}),self.layer=new Kinetic.Layer,self.groups.obstacles=new Kinetic.Group,self.layer.add(self.groups.obstacles),self.stage.add(self.layer),self.initPhysics(),self.addWall(),self.addObstacles(function(){var playerImg=new Image;playerImg.onload=function(){self.addPlayer(playerImg),pQuery(".player").attr("fixed",!0).data("view").hide(),pQuery.ticker.start(),self.world.unpause()},playerImg.src=document.getElementById("player-img").src})})},initPhysics:function(){var self=this,world;world=self.world=pQuery("world"),world.dimensions(this.bounds.width,this.bounds.height).on("step",function(){pQuery(".player").updateView()}).interact(pQuery.interactions.SphereCollide(.3),".collides").interact("beforeAccel",".gravity",function(dt,obj){obj.accelerate(self.globalAccel.x,self.globalAccel.y)}).interact(pQuery.interactions.ConstrainWithin(world,.3),".player"),world.pause(),pQuery.ticker.subscribe(function(time,dt){world.step(time),self.layer.draw()}),world.timeStep(16)},addWall:function(){var self=this,insideWall={min:pQuery.Vector(0,0),max:pQuery.Vector(60,self.bounds.height)},wall=new Kinetic.Rect({x:insideWall.max.x,y:0,width:60,height:self.bounds.height,alpha:0,fill:"white"});self.layer.add(wall),wall.on("click.wall tap.wall",function(e){var pos=self.stage.getUserPosition(e);wall.off("click.wall tap.wall"),self.breakWallAnim(pos.x,pos.y,function(hole){var player=pQuery(".player");player.position(pos.x,pos.y).attr("fixed",!1).velocity(0,Math.random()*.001).updateView().data("view").show()})})},addPlayer:function(image){var self=this,x=10,y=self.bounds.height/2,t=0,minV={x:-0.5,y:-0.5},maxV={x:.5,y:.5},v=pQuery.Vector(),player=pQuery("<sphere>"),shape=new Kinetic.Image({x:x,y:y,width:30,height:30,offset:15,image:image,draggable:!0});self.groups.moving=new Kinetic.Group,self.groups.moving.add(shape),self.layer.add(self.groups.moving),player.data("view",shape).dimensions(10).position(x,y).velocity(0,.01*Math.random()).addClass("gravity player collides").appendTo(self.world),player.on("collide",function(other){var v=this.velocity();other===self.world[0]&&v.x&&this.position().x>=self.bounds.width-this.dimensions().radius-10&&(this.velocity(0,0),self.endGame())})},addObstacles:function(cb){var self=this,radius=15,nrows=5,startForest=300,shape=new Kinetic.Circle({x:radius,y:radius,radius:radius-1,fill:"red",stroke:"black",strokeWidth:2});self.groups.obstacles.add(shape),shape.toImage({width:2*radius,height:2*radius,callback:function(img){var image,x,y,row=0,dx=60,dy=70;for(var i=0;(row=~~(i*dx/self.bounds.height))<nrows;++i){y=(row%2*dx/2+i*dx)%self.bounds.height+dx/2,x=row*dy+startForest,y+=15*(Math.random()-.5),x+=24*(Math.random()-.5);if(y+2*radius>self.bounds.height)continue;image=new Kinetic.Image({image:img,x:x,y:y,offset:radius}),self.world.append(pQuery("<sphere>").addClass("obstacle collides").position(x,y).dimensions(radius).data("view",image).attr("fixed",!0)),self.groups.obstacles.add(image)}self.layer.draw(),cb&&cb()}}),shape.hide()},breakWallAnim:function(x,y,cb){function anim(dt,time){startT=startT||time;var diff=time-startT,scale=Math.sin(diff*2*Math.PI/period)+.001;blueHex.setScale(scale),diff>period/4&&(self.world.off("step",anim),cb&&cb(blueHex))}var self=this,startT,period=2e3,blueHex=new Kinetic.RegularPolygon({x:x,y:y,sides:6,radius:30,fill:"#00D2FF",stroke:"black",strokeWidth:1});self.layer.add(blueHex),self.world.on("step",anim)},endGame:function(){var self=this;self.world.pause()}}}),require.config({baseUrl:"js/",shim:{"libs/kinetic":{exports:"Kinetic"}},map:{"*":{pquery:"libs/pquery/pquery",kinetic:"libs/kinetic",stapes:"libs/stapes"}}}),require(["mediators/plinko"],function(plinko){plinko.init()}),define("main",function(){})